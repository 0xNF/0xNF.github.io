<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head>
  <title>
    
        |
        Swipr - Swipr Script Service
      

    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="" />
  <meta
    name="description"
    content="Part 7 of the Swipr series. This post covers the construction of a service script to communicate with our trained model on a cpu-only server"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.ba004976221e613a16542d07a2deca5d0377ff5e6a22dec5fcec01480ba967cf.css"
      integrity="sha256-ugBJdiIeYToWVC0Hot7KXQN3/15qIt7F/OwBSAupZ88="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.793b323d7f2d9fbfd0b93f4d593fb5ad77b918716ed33eddea403fa87f770403.css"
    integrity="sha256-eTsyPX8tn7/QuT9NWT&#43;1rXe5GHFu0z7d6kA/qH93BAM="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7f3c2281c7f965ce3c64888aa452793252a0416909c181097f81d0a0f7d1624e.css"
    integrity="sha256-fzwigcf5Zc48ZIiKpFJ5MlKgQWkJwYEJf4HQoPfRYk4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.35fc032da8ede6681675d20a2f862fb9e1045c1d512d495fcf862c054daffef2.css"
    integrity="sha256-NfwDLajt5mgWddIKL4YvueEEXB1RLUlfz4YsBU2v/vI="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.3b92357925ea7284f0c6b0378396f39f470f7842ed9702f337e667c4026bf837.css"
    integrity="sha256-O5I1eSXqcoTwxrA3g5bzn0cPeELtlwLzN&#43;ZnxAJr&#43;Dc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.ebb1096e1976e8cc4e2532cfa050b8f30eb13b8eb06be5cee3e38eb426b838ea.css"
    integrity="sha256-67EJbhl26MxOJTLPoFC48w6xO46wa&#43;XO4&#43;OOtCa4OOo="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="https://0xnf.github.io/posts/ml/swipr07/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.5c846cefa5ed21cceee981c70901aaf21b17b4e0b05bd777af840780918abea9.js"
    integrity="sha256-XIRs76XtIczu6YHHCQGq8hsXtOCwW9d3r4QHgJGKvqk="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.46e991c2fcb035fc0060a792f1eb0c93ecacc9e76cd7445d6531a5cf2928686d.js"
      integrity="sha256-RumRwvywNfwAYKeS8esMk&#43;ysyeds10RdZTGlzykoaG0="
      crossorigin="anonymous"
    ></script>
  

  


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swipr - Swipr Script Service"/>
<meta name="twitter:description" content="Part 7 of the Swipr series. This post covers the construction of a service script to communicate with our trained model on a cpu-only server"/>



  
  <meta property="og:title" content="Swipr - Swipr Script Service" />
<meta property="og:description" content="Part 7 of the Swipr series. This post covers the construction of a service script to communicate with our trained model on a cpu-only server" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xnf.github.io/posts/ml/swipr07/" />
<meta property="article:published_time" content="2018-12-12T12:25:48-08:00" />
<meta property="article:modified_time" content="2018-12-12T12:25:48-08:00" />




  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "Swipr - Swipr Script Service",
        "headline": "Swipr - Swipr Script Service",
        "alternativeHeadline": "",
        "description": "
      Part 7 of the Swipr series. This post covers the construction of a service script to communicate with our trained model on a cpu-only server


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/0xnf.github.io\/posts\/ml\/swipr07\/"
        },
        "author" : {
            "@type": "Person",
            "name": ""
        },
        "creator" : {
            "@type": "Person",
            "name": ""
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": ""
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": ""
        },
        "copyrightYear" : "2018",
        "dateCreated": "2018-12-12T12:25:48.00Z",
        "datePublished": "2018-12-12T12:25:48.00Z",
        "dateModified": "2018-12-12T12:25:48.00Z",
        "publisher":{
            "@type":"Organization",
            "name":  null ,
            "url": "https://0xnf.github.io/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/0xnf.github.io\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/0xnf.github.io\/posts\/ml\/swipr07\/",
        "wordCount" : "607",
        "genre" : [ 
      
      "machine learning"

    
      
        ,

      
      "fast.ai"

    ],
        "keywords" : [ 
      
      "CNN"

    
      
        ,

      
      "web scraping"

    
      
        ,

      
      "data collection"

    
      
        ,

      
      "architecture"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/"></a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p></p>
      </div>
    </div>
    <ul class="sidebar__list">
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        
        2023
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.7d3bf3472b73d9ba107b3de37d0df8fa736593a3c6638c95eaed42006bfc0193.js"
    integrity="sha256-fTvzRytz2boQez3jfQ34&#43;nNlk6PGY4yV6u1CAGv8AZM="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>Swipr - Swipr Script Service</h1>
      <p>Now that we have a trained model, we need to consider how to interact with it.</p>
<p>The full tech of the script can be found <a href="https://github.com/0xNF/swipr_gh/tree/master/SwiprScript">here on GitHub</a> but we&rsquo;ll walk through it here too.</p>
<p>The overview of this step is that we have a python script acting as a local server where the client side of the script receives input and returns output to to external consumers, and the server side loads the PyTorch model and runs the computation.</p>
<p>Due to the computationally intensive exercise of setting up all the necessary PyTorch structures, loading the model, computing the result, and unloading the model for each request would be inadvisable - the local server architecture of the script allows us to keep the model loaded in memory at all times.</p>
<p>To accomplish this messaging service between client &amp; server, we use a library called <a href="http://zeromq.org/">ZeroMQ</a> to form a message queue between two forks of the process, and to keep the service alive at all times we add some extra infrastructure to make it an always-on systemd service.</p>
<h1 id="architecture-overview">Architecture overview</h1>
<p>the general architecture of this solution can be described by this chart:</p>
<p><img src="/ml/swipr/SSM.png" alt="ssm architecture"></p>
<p>The script invocation has two parts:</p>
<p>The first launches the server and doesn&rsquo;t return anything by itself</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python swiprscriptservice.py
</code></pre></div><p>the second launches the client, taking in a path to a valid image file and returning as output to stdout a comma separated tuple of float predictions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python swiprscriptservice.py --compute /path/to/img.jpg
0.66,0.33
</code></pre></div><h1 id="script-source">Script Source</h1>
<p>We have to load the script like we created it on our training machine. We could avoid doing it this way if we had bothered to save it properly as as a pickled object instead of just exporting the weights, but we didn&rsquo;t think of it at the time, so we have to do it the silly way, which involves bringing over a bunch of extra files like the val_idxs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">LoadLearner</span>():
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;loading learner&#34;</span>)
    <span style="color:#66d9ef">global</span> learn, tfms_va
    label_csv <span style="color:#f92672">=</span> PATH<span style="color:#f92672">/</span><span style="color:#e6db74">&#39;test1.csv&#39;</span>
    val_idxs <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(PATH<span style="color:#f92672">/</span><span style="color:#e6db74">&#39;val_idxs.pkl&#39;</span>)
    sz<span style="color:#f92672">=</span><span style="color:#ae81ff">224</span>
    arch<span style="color:#f92672">=</span>resnext50
    bs<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>
    tfms_tr, tfms_va <span style="color:#f92672">=</span> tfms_from_model(arch, sz, aug_tfms<span style="color:#f92672">=</span>transforms_side_on, max_zoom<span style="color:#f92672">=</span><span style="color:#ae81ff">1.1</span>)
    data <span style="color:#f92672">=</span> ImageClassifierData<span style="color:#f92672">.</span>from_csv(<span style="color:#e6db74">&#39;./&#39;</span>, <span style="color:#e6db74">&#39;./&#39;</span>, label_csv, val_idxs<span style="color:#f92672">=</span>val_idxs, tfms<span style="color:#f92672">=</span>(tfms_tr, tfms_va), bs<span style="color:#f92672">=</span>bs)
    learn <span style="color:#f92672">=</span> ConvLearner<span style="color:#f92672">.</span>pretrained(arch, data, precompute<span style="color:#f92672">=</span>False)
    learn<span style="color:#f92672">.</span>load(Swipr_ModelToUse)
    learn<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>cpu()
</code></pre></div><p>Next given a path to an image, we have to load it up in numpy and hand it to the model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">PredictOnImage</span>(ipath):
    i <span style="color:#f92672">=</span> open_image(ipath)
    t <span style="color:#f92672">=</span> tfms_va(i)  
    preds <span style="color:#f92672">=</span> learn<span style="color:#f92672">.</span>predict_array(t[None])
    x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>exp(preds)
    tup <span style="color:#f92672">=</span> (x[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>], x[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">return</span> tup
</code></pre></div><p>The rest of the script deals with using ZMQ and messaging between the client and server</p>
<p>One small aside if that we have a hardcoded killswitch built in if the server side of the process takes longer than 10 seconds to return:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">Kill</span>():
    os<span style="color:#f92672">.</span>_exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>()
    <span style="color:#f92672">...</span>
    t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Timer(<span style="color:#ae81ff">10.0</span>, Kill)
    <span style="color:#f92672">....</span>
    t<span style="color:#f92672">.</span>cancel()
</code></pre></div><p>This proved to be an occasional problem, so this is the workaround.</p>
<h1 id="script-start-script">Script Start Script</h1>
<p>Because we need to launch this service with a few conditions, we have a shell script that handles a number of external factors for us:</p>
<pre><code>#!/usr/bin/env bash
export PATH=/home/science/anaconda3/bin:$PATH
. /home/science/anaconda3/etc/profile.d/conda.sh
conda activate fastai-cpu
source ~/swipr/swiprvars.sh
python ./swiprsscriptserver.py &gt; ./sss_logs.txt
</code></pre><p>It makes sure the appropriate conda binaries are available to the script, that we&rsquo;re in the appropriate conda environment, that the necessary environment variables for Swipr are set, and to start the server.</p>
<h1 id="swipr-script-monitor">Swipr Script Monitor</h1>
<p>To install as systemd, we create a fairly typical service file describing our service:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Swipr Script Monitor&#34;</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network.target</span>
<span style="color:#a6e22e">StartLimitInterval</span><span style="color:#f92672">=</span><span style="color:#e6db74">200</span>
<span style="color:#a6e22e">StartLimitBurst</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>

<span style="color:#a6e22e">[Service]</span>
<span style="color:#a6e22e">User</span><span style="color:#f92672">=</span><span style="color:#e6db74">science</span>
<span style="color:#a6e22e">Group</span><span style="color:#f92672">=</span><span style="color:#e6db74">science</span>
<span style="color:#a6e22e">WorkingDirectory</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/science/swipr/swiprscript</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/science/swipr/swiprscript/sss_start.sh</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">always</span>
<span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">10</span>

<span style="color:#a6e22e">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p>We have it try an automatic restart every 3 minutes, and set it to attempt to always be online and available.</p>
<h1 id="moving-on">Moving On</h1>
<p>In our next post, we&rsquo;ll discuss the SwiprServer and its components</p>
<p><a href="/posts/ml/swipr08">Next Section - LibSwipr</a></p>



<h3>Posts in this series</h3>
<ul>
  
    <li><a href="/posts/ml/swipr10/">Swipr - Server</a></li>
  
    <li><a href="/posts/ml/swipr09/">Swipr - Datastore</a></li>
  
    <li><a href="/posts/ml/swipr08/">Swipr - LibSwipr</a></li>
  
    <li><a href="/posts/ml/swipr07/">Swipr - Swipr Script Service</a></li>
  
    <li><a href="/posts/ml/swipr06/">Swipr - Fast.ai and CNNs</a></li>
  
    <li><a href="/posts/ml/swipr05/">Swipr - Data Cleaning</a></li>
  
    <li><a href="/posts/ml/swipr04/">Swipr - Data Collection (Part 2 of 2)</a></li>
  
    <li><a href="/posts/ml/swipr03/">Swipr - Data Collection (Part 1 of 2)</a></li>
  
    <li><a href="/posts/ml/swipr02/">Swipr - Scope</a></li>
  
    <li><a href="/posts/ml/swipr01/">Swipr - Overview</a></li>
  
</ul>
</div>
    <div class="post__footer">
      
        <span><a class="category" href="/categories/machine-learning/">machine learning</a><a class="category" href="/categories/fast%2eai/">fast.ai</a></span>


      

      
        <span><a class="tag" href="/tags/cnn/">CNN</a><a class="tag" href="/tags/web-scraping/">web scraping</a><a class="tag" href="/tags/data-collection/">data collection</a><a class="tag" href="/tags/architecture/">architecture</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        
        2023
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.7d3bf3472b73d9ba107b3de37d0df8fa736593a3c6638c95eaed42006bfc0193.js"
    integrity="sha256-fTvzRytz2boQez3jfQ34&#43;nNlk6PGY4yV6u1CAGv8AZM="
    crossorigin="anonymous"
  ></script></body>
</html>
