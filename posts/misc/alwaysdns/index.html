<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><title>|
It's always DNS</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content><meta name=description content="In which an intractable database issue that couldn't have been DNS was in fact DNS the whole time."><link rel=stylesheet href=/scss/main.min.5794be192d21535bdd301561e043a96b6adbad2b5c08279deff459e4661c613f.css integrity="sha256-V5S+GS0hU1vdMBVh4EOpa2rbrStcCCed7/RZ5GYcYT8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://0xnf.github.io/posts/misc/alwaysdns/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="It's always DNS"><meta name=twitter:description content="In which an intractable database issue that couldn't have been DNS was in fact DNS the whole time."><meta property="og:title" content="It's always DNS"><meta property="og:description" content="In which an intractable database issue that couldn't have been DNS was in fact DNS the whole time."><meta property="og:type" content="article"><meta property="og:url" content="https://0xnf.github.io/posts/misc/alwaysdns/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-25T05:10:26-08:00"><meta property="article:modified_time" content="2019-02-25T05:10:26-08:00"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"It\u0027s always DNS","headline":"It\u0027s always DNS","alternativeHeadline":"","description":"
      In which an intractable database issue that couldn\u0027t have been DNS was in fact DNS the whole time.


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/0xnf.github.io\/posts\/misc\/alwaysdns\/"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":{"@type":"Person","name":""},"copyrightYear":"2019","dateCreated":"2019-02-25T05:10:26.00Z","datePublished":"2019-02-25T05:10:26.00Z","dateModified":"2019-02-25T05:10:26.00Z","publisher":{"@type":"Organization","name":null,"url":"https://0xnf.github.io/","logo":{"@type":"ImageObject","url":"https:\/\/0xnf.github.io\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/0xnf.github.io\/posts\/misc\/alwaysdns\/","wordCount":"644","genre":["development"],"keywords":["postgres","dotnet","networking"]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/ alt="profile picture"><div class=sidebar__introduction-title><a href=/></a></div><div class=sidebar__introduction-description><p></p></div></div><ul class=sidebar__list></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>It's Always DNS</h1><p>I had decided that I was going to re-visit the way Lyricall&rsquo;s infrastructure is deployed, because while functional, it was many complicated and esoteric steps away from &ldquo;one-click deploy&rdquo;. Near the completion of the .NET Core side of the deploy where it became time to test production-like connections to the primary, real database, problems started to arise.</p><p>No matter the configuration, .NET was spewing connection refused errors to the postgres backend. I tried the following diagnostic steps:</p><ol><li>use psql from my host machine to the production database. This succeeded.</li><li>use psql from my .NET machine to the production database. This succeeded.</li><li>Run Lyricall locally on my host machine to connect to the production database. This succeeded.</li><li>Run Lyricall on the .NET server to connect to the production database. This failed.</li></ol><p>In between running these steps, I had a number of other attempts at diagnostics as well. Changing the pg_hba.conf settings to accept progressively more open connections, add more detailed debug statements to the .NET server, hard code credentials into the server, remove environment variable resolution, etc.</p><p>Part of the diagnostics issue was that the ADO.NET provider Lyricall uses for postgres, npgsql, doesn&rsquo;t give fully detailed error messages. I was getting &ldquo;connection refused&rdquo; from npgsql, which was just turning into generic &ldquo;socket error&rdquo; from .NET. Deciding to check out psql pointed me into a more productive direction because it supplies fuller messages. In particular, the &ldquo;no pg_hba.conf entry for host&mldr;&rdquo; messages are much more helpful for figuring out what direction to go.</p><p>Getting that far prompted me to open the pb_hba.conf settings, but even after completely capitulating and both removing the <code>hostssl</code> lines and opening up connections to <code>host all all 0.0.0.0/0 md5</code>, functionally equivalent to &ldquo;literally anyone&rdquo;, it was still failing in 3 of the 4 tests outlined above.</p><p>At some point, with about as much hair remaining on my head as ideas to fix this inside it, I decided to just set up a listener on the postgres port on the database machine with <code>tcpdump -ni any port 5432</code> and watch what happens when the other 3 valid connections roll in.</p><p>Which is when things started to pick up.</p><p>Connecting successfully from my host machine via pgsql produced something like:</p><pre tabindex=0><code>[...many lines of similar looking stuff edited for brevity...]
13:43:16.872823 IP 230.143.164.118 &gt; 128.187.70.78: Flags [P.], seq 663:694, ack 3133, win 490, length 42
</code></pre><p>Connecting successfully from my host machine via the full local Lyricall produced the same output:</p><pre tabindex=0><code>[...many lines of similar looking stuff edited for brevity...]
13:45:12.231190 IP 230.143.164.118 &gt; 128.187.70.78: Flags [.], ack 5972, win 256, length 0
</code></pre><p>Connecting successfully from my .NET server via pgsql produced basically the same thing</p><pre tabindex=0><code>[...many lines of similar looking stuff edited for brevity...]
13:47:19.774503 IP 75.238.63.162 &gt; 128.187.70.78: Flags [.],  ack 695, win 490, length 0
</code></pre><p>&mldr;but launching the full Lyricall from the .NET server produced something starkly different:</p><pre tabindex=0><code>13:54:25.145636 IP6 c830:df10:45d:1cf5:c042:8a22:5523:6fa2 &gt; 7003:5172:8292:94ba:7eca:8557:89dc:25b8: Flags [P.],seq 651:682, ack 3128, win 545, options [nop,nop,TS val 3184622547 ecr 968662428], length 31 
</code></pre><p>That&rsquo;s a substantially different look than the others. That&rsquo;s not a regular address, that&rsquo;s an IPv6 address! This connection was refused.</p><p>For some reason, .NET on the server was resolving both the outgoing address and the database domain to their IPv6 addresses instead of their IPv4 addresses like it did every other time. This lead me to a bug in my postgres setup. Having neither any rules for allowing IPv6 host access, nor any IPv6 server listening addresses, it would of course refuse any such connections.</p><p>The solution was to fix that in my postgres configuration.</p><p>And once it was set properly, all 4 of the test cases succeeded.</p><p>I lost an entire weekend to this, by the way.</p><p>I still don&rsquo;t know why only one type of connection was resolving to IPv6, but DNS is weird, and it was DNS the whole time.</p></div><div class=post__footer><span><a class=category href=/categories/development/>development</a></span>
<span><a class=tag href=/tags/postgres/>postgres</a><a class=tag href=/tags/dotnet/>dotnet</a><a class=tag href=/tags/networking/>networking</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>