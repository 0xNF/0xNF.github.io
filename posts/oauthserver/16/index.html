<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><title>|
Implement an OAuth 2.0 Server (Part 16)</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content><meta name=description content="Here we implement Token Revocation using some custom views and controllers. We also let the user view what applications they have outstanding authorizations with."><link rel=stylesheet href=/scss/main.min.5794be192d21535bdd301561e043a96b6adbad2b5c08279deff459e4661c613f.css integrity="sha256-V5S+GS0hU1vdMBVh4EOpa2rbrStcCCed7/RZ5GYcYT8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://0xnf.github.io/posts/oauthserver/16/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Implement an OAuth 2.0 Server (Part 16)"><meta name=twitter:description content="Here we implement Token Revocation using some custom views and controllers. We also let the user view what applications they have outstanding authorizations with."><meta property="og:title" content="Implement an OAuth 2.0 Server (Part 16)"><meta property="og:description" content="Here we implement Token Revocation using some custom views and controllers. We also let the user view what applications they have outstanding authorizations with."><meta property="og:type" content="article"><meta property="og:url" content="https://0xnf.github.io/posts/oauthserver/16/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-06-18T18:11:50-07:00"><meta property="article:modified_time" content="2018-06-18T18:11:50-07:00"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/01/"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/02/"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/03/"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/04/"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/05/"><meta property="og:see_also" content="https://0xnf.github.io/posts/oauthserver/06/"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Implement an OAuth 2.0 Server (Part 16)","headline":"Implement an OAuth 2.0 Server (Part 16)","alternativeHeadline":"","description":"
      Here we implement Token Revocation using some custom views and controllers. We also let the user view what applications they have outstanding authorizations with.


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/0xnf.github.io\/posts\/oauthserver\/16\/"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":{"@type":"Person","name":""},"copyrightYear":"2018","dateCreated":"2018-06-18T18:11:50.00Z","datePublished":"2018-06-18T18:11:50.00Z","dateModified":"2018-06-18T18:11:50.00Z","publisher":{"@type":"Organization","name":null,"url":"https://0xnf.github.io/","logo":{"@type":"ImageObject","url":"https:\/\/0xnf.github.io\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/0xnf.github.io\/posts\/oauthserver\/16\/","wordCount":"1230","genre":["Security","Identity","Authentication","Authorization"],"keywords":["OAuth2.0","OpenIdConnect","Tutorial","CSharp",".NET Core"]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/ alt="profile picture"><div class=sidebar__introduction-title><a href=/></a></div><div class=sidebar__introduction-description><p></p></div></div><ul class=sidebar__list></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Implement an OAuth 2.0 Server (Part 16)</h1><p>Welcome to the sixteenth part of a series of posts where we will implement an OAuth 2 Server using <a href=https://github.com/aspnet-contrib/AspNet.Security.OpenIdConnect.Server>AspNet.Security.OpenIdConnectServer</a>.</p><h1 id=token-revocation>Token Revocation</h1><p>Token revocation is the process of invalidating already issued tokens. Because tokens are serialized with server data taken at a snapshot in time, there is no way for a token to know whether it&rsquo;s been invalidated, except for when it comes to its expiration date. Further, there&rsquo;s no given way for the server to know a token has been revoked either - at least, not without a backing datastore.</p><p>Thankfully, we&rsquo;ve been using SQLite to store generated tokens, and our <code>ValidationService</code> already checks to see if a token is valid beyond just its expiration date.</p><p>Because token revocation is an action that the user should perform, rather than one Client Application should perform, we will implement it as a method on the user&rsquo;s account management page.</p><p>That means we&rsquo;ll be leaving the <code>options.RevocationEndpointPath</code> in startup untouched.</p><pre><code>Note: We only revoke refresh tokens. It's too expensive to check whether an access token, which already has an inherently short lifetime, is valid or not on every request. Because refresh tokens are long lived, or in our case, infinitely so, we check them and not the others. 
</code></pre><h1 id=list-authorized-apps-under-manage>List Authorized Apps under /Manage</h1><p>The first step is to show the user a list of the applications they&rsquo;ve authorized on their behalf.</p><h2 id=viewmodel>ViewModel</h2><p>Under <code>Models/ManageViewModels/</code>, create a new one: <code>AuthorizedAppsViewModel.cs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthorizedAppsViewModel</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IList&lt;OAuthClient&gt; AuthorizedApps { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It does nothing except except display a list of clients.</p><h2 id=manage-navigation-12>Manage Navigation (1/2)</h2><p>Under <code>Views/Manage/ManageNavPages.cs</code>, add a few lines:</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ManageNavPages</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> ActivePageKey =&gt; <span style=color:#e6db74>&#34;ActivePage&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> Index =&gt; <span style=color:#e6db74>&#34;Index&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> ChangePassword =&gt; <span style=color:#e6db74>&#34;ChangePassword&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> ExternalLogins =&gt; <span style=color:#e6db74>&#34;ExternalLogins&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> TwoFactorAuthentication =&gt; <span style=color:#e6db74>&#34;TwoFactorAuthentication&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> AuthorizedApps =&gt; <span style=color:#e6db74>&#34;AuthorizedApps&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> IndexNavClass(ViewContext viewContext) =&gt; PageNavClass(viewContext, Index);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> ChangePasswordNavClass(ViewContext viewContext) =&gt; PageNavClass(viewContext, ChangePassword);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> ExternalLoginsNavClass(ViewContext viewContext) =&gt; PageNavClass(viewContext, ExternalLogins);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> TwoFactorAuthenticationNavClass(ViewContext viewContext) =&gt; PageNavClass(viewContext, TwoFactorAuthentication);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> AuthorizedAppsNavClass(ViewContext viewContext) =&gt; PageNavClass(viewContext, AuthorizedApps);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> PageNavClass(ViewContext viewContext, <span style=color:#66d9ef>string</span> page)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> activePage = viewContext.ViewData[<span style=color:#e6db74>&#34;ActivePage&#34;</span>] <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>string</span>.Equals(activePage, page, StringComparison.OrdinalIgnoreCase) ? <span style=color:#e6db74>&#34;active&#34;</span> : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> AddActivePage(<span style=color:#66d9ef>this</span> ViewDataDictionary viewData, <span style=color:#66d9ef>string</span> activePage) =&gt; viewData[ActivePageKey] = activePage;
</span></span><span style=display:flex><span>}</span></span></code></pre></div>This is step 1 of being able to navigate to the page we&rsquo;re about to create from the side nav-bar.</p><h2 id=manage-navigation-22>Manage Navigation (2/2)</h2><p>Under <code>Views/Manage/_ManageNav.cshtml</code>, add a reference to the strings we added above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-html data-lang=html><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>ul</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;nav nav-pills nav-stacked&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@ManageNavPages.IndexNavClass(ViewContext)&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Index&#34;</span>&gt;Profile&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@ManageNavPages.ChangePasswordNavClass(ViewContext)&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ChangePassword&#34;</span>&gt;Password&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    @if (hasExternalLogins)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@ManageNavPages.ExternalLoginsNavClass(ViewContext)&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ExternalLogins&#34;</span>&gt;External logins&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@ManageNavPages.TwoFactorAuthenticationNavClass(ViewContext)&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;TwoFactorAuthentication&#34;</span>&gt;Two-factor authentication&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex;background-color:#3c3d38><span>    &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@ManageNavPages.AuthorizedAppsNavClass(ViewContext)&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AuthorizedApps&#34;</span>&gt;Apps&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>ul</span>&gt;</span></span></code></pre></div><h2 id=authorized-applications-view>Authorized Applications View</h2><p>Under <code>Views/Manage/</code> create a new <code>view</code> named <code>AuthorizedApps</code> - Check the box for <code>Create as a Partial View</code>. Do not include a model or a context, and kepe the <code>template</code> and <code>Empty (without model)</code>.</p><p><img src=/oauthserver/part16/partialview.png alt="create as partial view"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>@using OAuthTutorial.Models.OAuth
</span></span><span style=display:flex><span>@model AuthorizedAppsViewModel
</span></span><span style=display:flex><span>@{
</span></span><span style=display:flex><span>    ViewData[&#34;Title&#34;] = &#34;Authorized Apps&#34;;
</span></span><span style=display:flex><span>    ViewData.AddActivePage(ManageNavPages.AuthorizedApps);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>h4</span>&gt;@ViewData[&#34;Title&#34;]&lt;/<span style=color:#f92672>h4</span>&gt;
</span></span><span style=display:flex><span>@if (Model.AuthorizedApps?.Count &gt; 0) {
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>table</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;table table-striped&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>tbody</span>&gt;
</span></span><span style=display:flex><span>            @foreach (OAuthClient client in Model.AuthorizedApps) {
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>tr</span>&gt;
</span></span><span style=display:flex><span>                    &lt;<span style=color:#f92672>td</span>&gt;
</span></span><span style=display:flex><span>                        &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>                            &lt;<span style=color:#f92672>strong</span>&gt;@client.ClientName&lt;/<span style=color:#f92672>strong</span>&gt;
</span></span><span style=display:flex><span>                            &lt;<span style=color:#f92672>p</span>&gt;@client.ClientDescription&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>                        &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>                    &lt;/<span style=color:#f92672>td</span>&gt;
</span></span><span style=display:flex><span>                    &lt;<span style=color:#f92672>td</span>&gt;
</span></span><span style=display:flex><span>                        &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>asp-action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Revoke&#34;</span> <span style=color:#a6e22e>asp-route-id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@client.ClientId&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>&gt;
</span></span><span style=display:flex><span>                            &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>                                &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;btn btn-default&#34;</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Deauthorize this application and remove it from your list&#34;</span>&gt;Remove&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>                            &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>                        &lt;/<span style=color:#f92672>form</span>&gt;     
</span></span><span style=display:flex><span>                    &lt;/<span style=color:#f92672>td</span>&gt;
</span></span><span style=display:flex><span>                &lt;/<span style=color:#f92672>tr</span>&gt;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>tbody</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>table</span>&gt;
</span></span><span style=display:flex><span>} else {
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>        You have no authorized applications! Go out and find some apps to play with.
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nothing special - just a regular list. The only interesting thing is that we&rsquo;ve included the <code>client.ClientId</code> as a route parameter of our button, which is going to <code>POST</code> to a method named <code>Revoke</code>.</p><p>Don&rsquo;t worry about not having the validation scripts that are normally present in every other view: they&rsquo;re taken care for us in the index page that will load this snippet.</p><h2 id=controller-13---applicationdbcontext>Controller (1/3) - ApplicationDbContext</h2><p>Open <code>Controllers/ManageController.cs</code>.</p><p>Because of the way the <code>UserManager</code> works, and because we&rsquo;ll need to examine and manipulate the actual <code>OAuthClients</code> and <code>Tokens</code>, we need a handler to our <code>ApplicationDbContext</code>. Dependency-inject it into our constructor like normal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Authorize]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;[controller]</span>/[action]<span style=color:#e6db74>&#34;)]
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ManageController</span> : Controller
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> UserManager&lt;ApplicationUser&gt; _userManager;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> SignInManager&lt;ApplicationUser&gt; _signInManager;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IEmailSender _emailSender;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger _logger;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> UrlEncoder _urlEncoder;
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ApplicationDbContext _context;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> AuthenticatorUriFormat = <span style=color:#e6db74>&#34;otpauth://totp/{0}:{1}?secret={2}&amp;issuer={0}&amp;digits=6&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> RecoveryCodesKey = nameof(RecoveryCodesKey);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ManageController(
</span></span><span style=display:flex><span>        UserManager&lt;ApplicationUser&gt; userManager,
</span></span><span style=display:flex><span>        SignInManager&lt;ApplicationUser&gt; signInManager,
</span></span><span style=display:flex><span>        IEmailSender emailSender,
</span></span><span style=display:flex><span>        ILogger&lt;ManageController&gt; logger,
</span></span><span style=display:flex><span>        UrlEncoder urlEncoder,
</span></span><span style=display:flex;background-color:#3c3d38><span>        ApplicationDbContext context)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _userManager = userManager;
</span></span><span style=display:flex><span>        _signInManager = signInManager;
</span></span><span style=display:flex><span>        _emailSender = emailSender;
</span></span><span style=display:flex><span>        _logger = logger;
</span></span><span style=display:flex><span>        _urlEncoder = urlEncoder;
</span></span><span style=display:flex;background-color:#3c3d38><span>        _context = context;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=controller-23---get>Controller (2/3) - GET</h2><p>Near the bottom, add GET support for our new page:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[HttpGet]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; AuthorizedApps() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> uid = _userManager.GetUserId(User);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (String.IsNullOrWhiteSpace(uid)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>$&#34;Unable to load user with ID &#39;{uid}&#39;.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IEnumerable&lt;Token&gt; userstokens = (<span style=color:#66d9ef>await</span> _context.Users.Include(x =&gt; x.UserClientTokens).FirstOrDefaultAsync(x =&gt; x.Id == uid))?.UserClientTokens;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(userstokens == <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>$&#34;Unable to load user apps for user ID &#39;{uid}&#39;.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IList&lt;OAuthClient&gt; items = _context.ClientApplications.Include(x =&gt; x.UserApplicationTokens).Where(x =&gt; x.UserApplicationTokens.Any(y =&gt; userstokens.Contains(y))).ToList();
</span></span><span style=display:flex><span>    AuthorizedAppsViewModel aavm = <span style=color:#66d9ef>new</span> AuthorizedAppsViewModel() {
</span></span><span style=display:flex><span>        AuthorizedApps = items,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> View(aavm);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For each token that the user has associated to them, we get the <code>OAuthClient</code> that issued it, then return that list to the user.</p><h2 id=controller-33---post>Controller (3/3) - POST</h2><p>Beneath the GET, add one final method, the post for our View:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[HttpPost, ActionName(&#34;revoke/{id}&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[ValidateAntiForgeryToken]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; Revoke(<span style=color:#66d9ef>string</span> id) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> uid = _userManager.GetUserId(User);
</span></span><span style=display:flex><span>    ApplicationUser user = <span style=color:#66d9ef>await</span> _context.Users.Include(x =&gt; x.UserClientTokens).FirstOrDefaultAsync(x =&gt; x.Id == uid);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (user == <span style=color:#66d9ef>null</span> || String.IsNullOrWhiteSpace(uid)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>$&#34;Unable to load user with ID &#39;{uid}&#39;.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    OAuthClient client = <span style=color:#66d9ef>await</span> _context.ClientApplications.Include(x =&gt; x.UserApplicationTokens).FirstOrDefaultAsync(x =&gt; x.ClientId == id);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (String.IsNullOrWhiteSpace(id) || client == <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>$&#34;Supplied client id was invalid&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IList&lt;Token&gt; tokens = client.UserApplicationTokens.Intersect(client.UserApplicationTokens).ToList();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span>(Token t <span style=color:#66d9ef>in</span> tokens) {
</span></span><span style=display:flex><span>        _context.Tokens.Remove(t);
</span></span><span style=display:flex><span>        client.UserApplicationTokens.Remove(t);
</span></span><span style=display:flex><span>        user.UserClientTokens.Remove(t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    _context.ClientApplications.Update(client);
</span></span><span style=display:flex><span>    _context.Users.Update(user);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> _context.SaveChangesAsync();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RedirectToAction(nameof(AuthorizedApps));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We compare tokens from our user based on the client id they submitted to us with the <code>POST /revoke/{id}</code> request, and for each matching token returned from the database, we remove it from the <code>Tokens</code> table, we remove its reference from the <code>OAuthClient</code> entry, and we remove it from our <code>User</code>. Since everything is <code>ON DELETE CASCADE</code> just removing it from the <code>Tokens</code> table should be enough, but we can afford to be thorough so we will.</p><p>Finally we update our tracked items, save our changes, and then reload the page.</p><h1 id=testing-revocation>Testing Revocation</h1><p>Start the server and if you haven&rsquo;t already, create a user, create a client, and issue a token from that client. If you haven&rsquo;t deleted your database from the previous section, this is already done for you.</p><p>Navigate to http://localhost:5000/manage and check out the apps you&rsquo;ve authorized:</p><p><img src=/oauthserver/part16/apps.png alt="create as partial view"></p><p>Click the Remove button, and you the page should refresh, but be empty this time:</p><p><img src=/oauthserver/part16/noapps.png alt="create as partial view"></p><h1 id=revoking-access-tokens>Revoking Access Tokens</h1><p>We don&rsquo;t revoke access tokens because it would be expensive to check the validity against the database for each request, but if you want to do so, it wouldn&rsquo;t be difficult to adjust our design to account for that.</p><p>We already store all currently issued access tokens and our Revoke method already deletes all issued tokens to a user/client combo, so the only things to do would be to add a <code>CheckAccessTokenStillValid</code> to the <code>ValidationService</code> class and call it in the <code>[RateLimit]</code> attribute.</p><h1 id=moving-on>Moving On</h1><p>The demo of this project to this point can be found <a href=https://github.com/0xNF/OAuthTutorial/tree/16-TokenRevoke>here on GitHub</a>.</p><p>In the next section, we&rsquo;ll add Rate Limiting to our application.</p><p><a href=/posts/oauthserver/17>Next</a></p><h3>Posts in this series</h3><ul><li><a href=/posts/oauthserver/19/>Implement an OAuth 2.0 Server (Part 19)</a></li><li><a href=/posts/oauthserver/18/>Implement an OAuth 2.0 Server (Part 18)</a></li><li><a href=/posts/oauthserver/17/>Implement an OAuth 2.0 Server (Part 17)</a></li><li><a href=/posts/oauthserver/16/>Implement an OAuth 2.0 Server (Part 16)</a></li><li><a href=/posts/oauthserver/15/>Implement an OAuth 2.0 Server (Part 15)</a></li><li><a href=/posts/oauthserver/14/>Implement an OAuth 2.0 Server (Part 14)</a></li><li><a href=/posts/oauthserver/13/>Implement an OAuth 2.0 Server (Part 13)</a></li><li><a href=/posts/oauthserver/12/>Implement an OAuth 2.0 Server (Part 12)</a></li><li><a href=/posts/oauthserver/11/>Implement an OAuth 2.0 Server (Part 11)</a></li><li><a href=/posts/oauthserver/10/>Implement an OAuth 2.0 Server (Part 10)</a></li><li><a href=/posts/oauthserver/09/>Implement an OAuth 2.0 Server (Part 09)</a></li><li><a href=/posts/oauthserver/08/>Implement an OAuth 2.0 Server (Part 08)</a></li><li><a href=/posts/oauthserver/07/>Implement an OAuth 2.0 Server (Part 07)</a></li><li><a href=/posts/oauthserver/06/>Implement an OAuth 2.0 Server (Part 06)</a></li><li><a href=/posts/oauthserver/05/>Implement an OAuth 2.0 Server (Part 05)</a></li><li><a href=/posts/oauthserver/04/>Implement an OAuth 2.0 Server (Part 04)</a></li><li><a href=/posts/oauthserver/03/>Implement an OAuth 2.0 Server (Part 03)</a></li><li><a href=/posts/oauthserver/02/>Implement an OAuth 2.0 Server (Part 02)</a></li><li><a href=/posts/oauthserver/01/>Implement an OAuth 2.0 Server (Part 01)</a></li></ul></div><div class=post__footer><span><a class=category href=/categories/security/>Security</a><a class=category href=/categories/identity/>Identity</a><a class=category href=/categories/authentication/>Authentication</a><a class=category href=/categories/authorization/>Authorization</a></span>
<span><a class=tag href=/tags/oauth2%2e0/>OAuth2.0</a><a class=tag href=/tags/openidconnect/>OpenIdConnect</a><a class=tag href=/tags/tutorial/>Tutorial</a><a class=tag href=/tags/csharp/>CSharp</a><a class=tag href=/tags/%2enet-core/>.NET Core</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>