<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><title>|
Lyricall Security</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content><meta name=description content="Security overview of lyricall.net as of May 2018. We talk data ownership, data boundaries, encrypted connections, and validation."><link rel=stylesheet href=/scss/main.min.5794be192d21535bdd301561e043a96b6adbad2b5c08279deff459e4661c613f.css integrity="sha256-V5S+GS0hU1vdMBVh4EOpa2rbrStcCCed7/RZ5GYcYT8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://0xnf.github.io/posts/lyricall/security/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Lyricall Security"><meta name=twitter:description content="Security overview of lyricall.net as of May 2018. We talk data ownership, data boundaries, encrypted connections, and validation."><meta property="og:title" content="Lyricall Security"><meta property="og:description" content="Security overview of lyricall.net as of May 2018. We talk data ownership, data boundaries, encrypted connections, and validation."><meta property="og:type" content="article"><meta property="og:url" content="https://0xnf.github.io/posts/lyricall/security/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-22T17:02:40-07:00"><meta property="article:modified_time" content="2018-05-22T17:02:40-07:00"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Lyricall Security","headline":"Lyricall Security","alternativeHeadline":"","description":"
      Security overview of lyricall.net as of May 2018. We talk data ownership, data boundaries, encrypted connections, and validation.


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/0xnf.github.io\/posts\/lyricall\/security\/"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":{"@type":"Person","name":""},"copyrightYear":"2018","dateCreated":"2018-05-22T17:02:40.00Z","datePublished":"2018-05-22T17:02:40.00Z","dateModified":"2018-05-22T17:02:40.00Z","publisher":{"@type":"Organization","name":null,"url":"https://0xnf.github.io/","logo":{"@type":"ImageObject","url":"https:\/\/0xnf.github.io\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/0xnf.github.io\/posts\/lyricall\/security\/","wordCount":"1361","genre":["lyricall","architecture","c#","security","database design",".net core","spotify"],"keywords":[]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/ alt="profile picture"><div class=sidebar__introduction-title><a href=/></a></div><div class=sidebar__introduction-description><p></p></div></div><ul class=sidebar__list></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Lyricall Security</h1><p>This is the Security Model for lyricall.net as of May 22nd, 2018.</p><h1 id=security-model>Security Model</h1><p>tl;dr:</p><ol><li>The servers are secure</li><li>The services are secure</li><li>Connections are secure</li><li>Data is validated</li><li>Ownership is checked</li></ol><p>todo:</p><ol><li>Encrypt db at Rest</li><li>Automatically rotate dbhost/dbname/dbuer/dbpassword values</li><li>Spin out authentication server from api server</li><li>Spin out client server from api server</li></ol><h2 id=server-provisioning>Server Provisioning</h2><p>All machines are provisioned in the standard manner:</p><ol><li>SSH key only access, no password authentication allowed</li><li>Standard SSH port is changed to be non-standard below 1024 to stop automated attacks on port 22<ul><li>Ports below 1024 are privileged and can&rsquo;t be re-bound by another service.</li></ul></li><li>No Root sign-on. Root only available via <code>sudo su</code> from an authenticated user</li><li>Access is done under an unprivileged user with an entry in <code>sudoers</code></li><li>UFW is running with only the necessary service ports open.<ul><li>ssh</li><li>whichever applications are running</li></ul></li></ol><h2 id=data-boundaries>Data Boundaries</h2><p>Any time a data-boundary is crossed, that boundary is treated as adversarial, and all data traveling across is verified before committed or consumed.</p><p>The data boundaries for Lyricall are diagrammed here:</p><pre><code>                                        + &lt;--&gt; Spotify Server (4)
                                        |
  Web Client (1. &lt;-&gt; API Server (2. &lt;-&gt; +
                                        |
                                        + &lt;--&gt; Database Server (3)
</code></pre><p>Data is validated on both ends of each boundary before passing along or using, with the exception of the Spotify Server which we don&rsquo;t control, and therefore cannot validate on their end. We do however, validate data coming back from it and going into it, according to the specs published on the <a href=https://developer.spotify.com>https://developer.spotify.com</a> documentation site.</p><h3 id=transport-security>Transport Security</h3><p>All connections between data boundaries are secured behind TLS/SSL, courtesy of Let&rsquo;s Encrypt.</p><p>Connections to the API Server and the Database Server are HTTPS only, and connections made via HTTP are rejected. This means that an attacker isn&rsquo;t afforded the opportunity to perform something like <code>sslstrip</code>.</p><h2 id=basic-guarantees>Basic Guarantees</h2><p>Because we use C# with strong models, we have a minimum guarantee of runtime safety and data validation. As long as the models are conceptually correct, a lot of errors are automatically eliminated. Barring any incorrect implementations in the underlying libraries, buffer overflows or invalid states are impossible.</p><h2 id=database-side>Database Side</h2><p>The Database server resides on its own separate machine.</p><pre><code>Postgres is not encrypted at rest, and none of the columns, tables, or databases are encrypted by default. 
</code></pre><h3 id=config-settings>Config Settings</h3><ol><li>Postgres port is changed to reduce automated scan attack surface.</li><li>Postgres, via <code>pg_hba.conf</code> is configured to allow access when accessing via <code>localhost</code>, but only allows known ip ranges with known users, to known databases when connecting remotely.</li><li>All remote connections require SSL. Local connections are exempt from this requirement.</li><li>Of course even when connecting locally, authentication is necessary.</li></ol><h3 id=user-settings>User Settings</h3><ol><li><p>Main database uses a strong, secure, randomly generated 64-character string</p></li><li><p>Database is only accessible via a specific, lowest-privilege user, whose name is an equally random 64-character string.</p></li><li><p>This user has an equally random 64-character string password</p></li><li><p>This user only has access to the app-database, and can not modify other Databases. It is not even an Administrator on the database. It has read-write access to most tables, but a second, more privileged Administrator user exists to execute various administrative tasks, like manually adjusting a users subscription.</p><pre><code> In the future, these values will be rotated out occasionally.
</code></pre></li></ol><h3 id=data-validation-incoming-to-database-boundary-2-3>Data Validation, Incoming to Database (Boundary 2->3)</h3><p>We make extensive use of the Postgres <code>CHECK</code> clause when constructing tables and inserting data to ensure data integrity.</p><p>For example, <code>CONSTRAINT "Ensure Max Redemptions is uint" CHECK (("MaxRedemptions" >= 0))</code> makes sure that we don&rsquo;t submit any negative numbers to a field where it wouldn&rsquo;t make any sense if we did.</p><p>Foreign Key relationships also exist in most tables to help with cascading deletes as well as data integrity to protect against non-existent users or malicious/malformed data.</p><h2 id=api-server>API Server</h2><p>The API server resides on its own separate machine.
The server runs Dot Net Core&rsquo;s Kestrel server, behind an nginx instance.</p><h3 id=logging>Logging</h3><p>Substantial logging occurs on the server allowing for appropriate security monitoring as well as developer debugging.</p><h3 id=access-control>Access Control</h3><pre><code>Authentication is presently mixed with this server, and will be spun out to its own instance at a later date. 
</code></pre><p>Users must sign in with their Spotify account via the OAuth2 protocol. ASPNET security / EF Core modules handle safe storage of tokens and hashed user credentials.</p><p>All API calls require proper authentication, as well as proper authorization. API calls that are not authenticated simply return <code>403 forbidden</code> as the status message. This is provided by the ASPNET Identity middleware and the <code>[Authorize (Role='member')]</code> attribute on the controllers and methods.</p><p>Authentication is provided by the ASPNET Identity middleware and supplies a client cookie.</p><p>Authorization is specified by roles. At the moment, everyone who signs up receives a role of <code>member</code>, which allows them access to the basic API.</p><p>A separate role of <code>administrator</code> exists and is only for support and statistics purposes.</p><p>These roles are not transmitted by or to the users, and are only validated by the server against the database to check if a user has appropriate permissions for the given action. A user is not able to tell the server what role they possess.</p><p>Users are only able to access a handful of public pages if they are not signed in. All browser requests to forbidden or authentication-required resources result in a redirect to a 403 Error page.</p><h3 id=secrets>Secrets</h3><p>Secrets such as the Spotify Client Secret or the Postgres Database Password are stored in environment variables only accessible to the webserver user. These secrets are not hardcoded in the source, nor are submitted by any user. They are transported only to the necessary endpoints via a secured channel.</p><p>Secrets are not checked into the git repositories and will not be found in the source, either in code or in config files.</p><h3 id=data-validation-incoming-from-client-api-boundary-1-2>Data Validation, Incoming from Client API (Boundary 1->2)</h3><p>For data being supplied by a client accessing the Client API, we validate all data with a number of checks, since we cannot guarantee that someone hitting the client endpoints is from the official webclient, or that the data in transit hasn&rsquo;t been manufactured, tampered with, or otherwise corrupted.</p><ol><li>For pagination requests, we validate that the limits and offsets are within bounds.</li><li>For updates, we check that any given Spotify Playlists are in the correct format according to the Spotify specifications</li><li>We check that a Spotify playlist still exists on Spotify&rsquo;s servers</li><li>If a playlist is being modified, we check that the resource is owned by the requesting user. Tampering with someone else&rsquo;s playlist is not allowed, even if the ID of the playlist is known.</li><li>For Rules, we validate that the data is well formatted, and follows the Limits for the user. i.e., respects the Max_Nesting_Depth, and Max_Sources_Per_Playlist.</li><li>We also check that Rule values are within acceptable ranges. A field that operates upon doubles between 0.0 and 1.0 should refuse values outside that range. Similarly, it should fail for non-double values like strings or bytes.</li><li>Rules are also checked that the supplied field is valid. There is no rule by the property name of <code>nonexistantrulelol</code>, so the presence of a supplied field not matching a known property results in rejection.</li></ol><h3 id=data-validation-outgoing-to-database-boundary-2-3>Data Validation, Outgoing to Database (Boundary 2->3)</h3><p>Values are not inserted by appending to a query, all values are substituted with Prepared Statements.</p><h3 id=data-validation-incoming-from-database-boundary-3-2>Data Validation, Incoming from Database (Boundary 3->2)</h3><p>Data is validated against statically, strongly typed models. Due to the nature of the enum-like classes, Rules are automatically guaranteed to be correct.</p><h2 id=web-client>Web Client</h2><pre><code>Server hosting the Web Client is mixed with the Authentication and API Server. In the future, it should be moved to its own machine. At the moment this is difficult due to the .net antiforgery token system.
</code></pre><h3 id=data-validation-incoming-from-api-server-boundary-2-1>Data Validation, Incoming from API Server (Boundary 2->1)</h3><p>The web client is written in TypeScript and validates all incoming data according to the models described in the source.</p><h3 id=data-validation-outgoing-to-api-server-boundary-1-2>Data Validation, Outgoing to API Server (Boundary 1->2)</h3><p>Prior to sending any data, the client checks and prevents invalid rule, rulegroup, or playlist states.</p><p>This is mostly a quality of life improvement for the user, because any data can be modified and sent to the server. Validation is far stricter and more useful at other Boundaries.</p></div><div class=post__footer><span><a class=category href=/categories/lyricall/>lyricall</a><a class=category href=/categories/architecture/>architecture</a><a class=category href=/categories/c%23/>c#</a><a class=category href=/categories/security/>security</a><a class=category href=/categories/database-design/>database design</a><a class=category href=/categories/%2enet-core/>.net core</a><a class=category href=/categories/spotify/>spotify</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>