<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Table of Contents  Architecture of lyricall.net  Technology tl;dr: App Overview Front End  Redux React  Back End Database - PostgresQL  Why Postgres Database Schema Lyricall Tables Straggler Tables ASP.NET / Entity Framework Tables  Server - .NET Core 2.0 / ASP.NET Core 2.0  Why .NET Core Intermission - the DotNetStandardSpotifyWebApi library Intermission - the ASP.NET Security Project API Server Architecture Entity Framework vs Hand Crafted SQL Automatic Timed Services Services Models Validation Scanning  Hosting Digital Ocean  Security Backups CI/CD  Microsoft Azure  Backups CI/CD  Let&rsquo;s Encrypt   Architecture of lyricall.'>

<meta property='og:title' content='Lyricall Architecture • 0xNF'>
<meta property='og:description' content='Table of Contents  Architecture of lyricall.net  Technology tl;dr: App Overview Front End  Redux React  Back End Database - PostgresQL  Why Postgres Database Schema Lyricall Tables Straggler Tables ASP.NET / Entity Framework Tables  Server - .NET Core 2.0 / ASP.NET Core 2.0  Why .NET Core Intermission - the DotNetStandardSpotifyWebApi library Intermission - the ASP.NET Security Project API Server Architecture Entity Framework vs Hand Crafted SQL Automatic Timed Services Services Models Validation Scanning  Hosting Digital Ocean  Security Backups CI/CD  Microsoft Azure  Backups CI/CD  Let&rsquo;s Encrypt   Architecture of lyricall.'>
<meta property='og:url' content='https://0xNF.github.io/posts/lyricall-architecture-00/'>
<meta property='og:site_name' content='0xNF&#39;s Blog - This site will never be updated'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2017-11-30T13:21:42-08:00'/><meta property='article:modified_time' content='2017-11-30T13:21:42-08:00'/>

<meta name="generator" content="Hugo 0.27.1" />

  <title>Lyricall Architecture • 0xNF</title>
  <link rel='canonical' href='https://0xNF.github.io/posts/lyricall-architecture-00/'>
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700&subset=latin'>
<link rel='stylesheet' href='/css/main.67a788c9.css'>

  <link rel='stylesheet' href='/css/prism.css'>



</head>


<body class='page'>
  <div class='site'>
    <header id='header' class='header-container'>
      <div class='site-header'>
        <nav id='navmenu' aria-label='Main Menu'>
  <ul class='main-menu'>
    
    <li>
      <a href='https://0xNF.github.io' 
        
      >Repo</a>
    </li>
    
  </ul>
</nav>

        <div class='site-info'>
          
          <p class='site-title title'>0xNF&#39;s Blog - This site will never be updated</p>
          
          <p class='site-description'>Technical Things</p>
        </div>
      </div>
    </header>


<main class='main'>
  <article lang='en' class='entry'>
    <header class='entry-header'>
  <div class='entry-info'>
    <h1 class='entry-title title'>Lyricall Architecture</h1>
    
  </div>
  
<div class='meta'>
  <span class='posted-on'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>

    <span class='screen-reader'>Posted on </span>
    <time class='date' datetime='2017-11-30T13:21:42-08:00'>2017, Nov 30</time>
  </span>
  
  <span class='byline'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>

    <span class='screen-reader'> by </span>
    0xNF
  </span>
  
  
  <span class='reading-time'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/> 
  
</svg>

    34 mins read
  </span>
  
</div>


</header>

    <div class='entry-content'>
  

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
<li><a href="#architecture-of-lyricallnet">Architecture of lyricall.net</a>

<ul>
<li><a href="#technology-tldr">Technology tl;dr:</a></li>
<li><a href="#app-overview">App Overview</a></li>
<li><a href="#front-end">Front End</a>

<ul>
<li><a href="#redux">Redux</a></li>
<li><a href="#react">React</a></li>
</ul></li>
<li><a href="#back-end">Back End</a></li>
<li><a href="#database---postgresql">Database - PostgresQL</a>

<ul>
<li><a href="#why-postgres">Why Postgres</a></li>
<li><a href="#database-schema">Database Schema</a></li>
<li><a href="#lyricall-tables">Lyricall Tables</a></li>
<li><a href="#straggler-tables">Straggler Tables</a></li>
<li><a href="#aspnet--entity-framework-tables">ASP.NET / Entity Framework Tables</a></li>
</ul></li>
<li><a href="#server---net-core-20--aspnet-core-20">Server - .NET Core 2.0 / ASP.NET Core 2.0</a>

<ul>
<li><a href="#why-net-core">Why .NET Core</a></li>
<li><a href="#intermission---the-dotnetstandardspotifywebapi-library">Intermission - the DotNetStandardSpotifyWebApi library</a></li>
<li><a href="#intermission---the-aspnet-security-project">Intermission - the ASP.NET Security Project</a></li>
<li><a href="#api">API</a></li>
<li><a href="#server-architecture">Server Architecture</a></li>
<li><a href="#entity-framework-vs-hand-crafted-sql">Entity Framework vs Hand Crafted SQL</a></li>
<li><a href="#automatic-timed-services">Automatic Timed Services</a></li>
<li><a href="#services">Services</a></li>
<li><a href="#models">Models</a></li>
<li><a href="#validation">Validation</a></li>
<li><a href="#scanning">Scanning</a></li>
</ul></li>
<li><a href="#hosting">Hosting</a></li>
<li><a href="#digital-ocean">Digital Ocean</a>

<ul>
<li><a href="#security">Security</a></li>
<li><a href="#backups">Backups</a></li>
<li><a href="#cicd">CI/CD</a></li>
</ul></li>
<li><a href="#microsoft-azure">Microsoft Azure</a>

<ul>
<li><a href="#backups-1">Backups</a></li>
<li><a href="#cicd-1">CI/CD</a></li>
</ul></li>
<li><a href="#lets-encrypt">Let&rsquo;s Encrypt</a></li>
</ul></li>
</ul>

<h1 id="architecture-of-lyricall-net">Architecture of lyricall.net</h1>

<p><img height="75" width="75" src="/img/lyricallarch/lyricall.svg"/></p>

<h2 id="technology-tl-dr">Technology tl;dr:</h2>

<p>Front End</p>

<ul>
<li>React</li>
<li>Redux</li>
<li>TypeScript</li>
</ul>

<p>Back End</p>

<ul>
<li>ASP.NET Core 2.0</li>
</ul>

<p>Database</p>

<ul>
<li>Postgresql</li>
</ul>

<p>Hosting</p>

<ul>
<li>Database: Digital Ocean</li>
<li>Server: Microsoft Azure</li>
</ul>

<blockquote>
<p>Developer Note:<br>
It&rsquo;s worth mentioning that prior to this endeavor, my experience in software development had been on desktop clients, command line utilities, and high performance computation. My experience with most of these technologies, ecosystems, and practices, including HTML/CSS was either virtually or truly zero, and as such almost every single aspect of this project involved learning substantial amounts of new technologies and concepts.</p>
</blockquote>

<h2 id="app-overview">App Overview</h2>

<p><img src="/img/lyricallarch/NetworkDiagram.png" height="300"></p>

<p>Lyricall is classic client-server application. The front end client is an <code>ASP.NET Core 2.0</code> program running on a Microsoft Azure instance, and the back end is a Digital Ocean-hosted Ubuntu VM running a <code>Postgres 9.5</code> instance.</p>

<p>Except for the initial OAuth authorization flow between the user and Spotify, all communication with Spotify&rsquo;s servers happen from the .NET back end server.</p>

<h2 id="front-end">Front End</h2>

<p>The front end is split into three distinctive parts:</p>

<ul>
<li>Static HTML</li>
<li>Server Rendered Razor Page</li>
<li>Client Rendered React-Redux app</li>
</ul>

<p>In the future reducing the number of different technologies involved in rendering various pages of the front end would be nice to do, but this is the present state of affairs.</p>

<p>The pages found under lyricall.net/faq and lyricall.net/privacy are static HTML files that are served by the back end directly with a <code>text/html</code> encoding.</p>

<p>The landing page at lyricall.net/ is a server rendered Razor Page. Originally this page was also a plain HTML file, but because authenticating with Spotify and logging into the application is supported from the front page, and because ASP.NET encourages, by default, to use Anti-XRSF tokens, it was easier to render the page dynamically because as a Razor Page View, it can insert the necessary Anti-XRSF token onto the page itself.</p>

<p>And thirdly, the actual webapp located under lyricall.net/app is a client rendered Reect-Redux application.</p>

<p><img height="32" width="135" src="/img/lyricallarch/ts.svg"></p>

<p>The front end is delivered as a React-Redux application, but is built as a TypeScript project, which, knowing nothing about Front End development, was made doable with <a href="https://github.com/Microsoft/TypeScript-React-Starter">Microsoft&rsquo;s react-typescript starter project</a>.</p>

<p>The client has the following structure:</p>

<ul>
<li>src/

<ul>
<li>actions/</li>
<li>actionCreators/</li>
<li>actionInterfaces/</li>
<li>actionTypes/</li>
<li>components/</li>
<li>containers/</li>
<li>models/</li>
<li>reducers/</li>
<li>services/</li>
<li>stores/</li>
</ul></li>
</ul>

<p>Meanwhile this what the Redux State Store looks like.:</p>

<pre><code class="language-TypeScript">interface LyricallStoreShape {
    readonly User: User;
    readonly LoadingSection: LoadingSectionShape;
    readonly Selection: SelectionShape;
    readonly CurrentPages: CurrentPagesShape;
    readonly PageCache: PageCacheShape;
    readonly FullSmartPlaylistsCache: FullSmartPlaylistsCacheShape;
    readonly AvailableProperties: Property[];
}

export interface LoadingSectionShape {
    readonly IsLoading: boolean;
    readonly IsModalOpen: boolean;
    readonly ErrorMessage: string;
}

export interface SelectionShape {
    readonly SmartPlaylist: SmartPlaylist;
    readonly DidModify: boolean;
    readonly SelectedPlaylistSourcesPage: Paging&lt;SpotifyPlaylist | UserLibrary&gt;;        
    readonly SelectedAddedTracksPage?: Paging&lt;Track&gt;;  
    readonly IsLoading: boolean;
    readonly ErrorMessage: string | null;
}

export interface CurrentPagesShape {
    readonly SpotifySourcesPage: Paging&lt;UserLibrary | SpotifyPlaylist&gt; | null;
    readonly SuggestedListenersPage: Paging&lt;RuleGroup&gt; | null;
    readonly SimpleSmartPlaylistsPage: Paging&lt;SimpleSmartPlaylist&gt; | null;
}

export interface PageCacheShape {    
    readonly SimpleSmartPlaylistCache: PageCache&lt;SimpleSmartPlaylist&gt;;
    readonly SpotifySourcesCache: PageCache&lt;UserLibrary | SpotifyPlaylist&gt;;
    readonly AvailableListenersCache: PageCache&lt;RuleGroup&gt;;
}

export interface FullSmartPlaylistsCacheShape {
    readonly IsInavlid: boolean;
    readonly SmartPlaylists: Map&lt;string, SmartPlaylist&gt;;
}
</code></pre>

<blockquote>
<p>It is my understanding that <code>null</code> is poor form and non-idiomatic TypeScript, but like many first iteration products, especially in a technology that the developer is completely new to, non-idiomatic patterns find their way into the codebase. Coming from a C# background with almost no substantial experience in JavaScript, nulls are a well-understood pattern. Making proper usage of TypeScript&rsquo;s <code>undefined</code> and optional arguments is slated for the next iteration.</p>
</blockquote>

<p>When a sign in is successful or when the session cookie is authenticated, the app performs a number of immediate actions:</p>

<ul>
<li>Setting the current User</li>
<li>Zeroing out all the caches</li>
<li>Fetching the user&rsquo;s pre-existing Smart Playlists</li>
<li>Fetching the user&rsquo;s Spotify Playlists</li>
<li>Fetching the pre-made Listeners</li>
</ul>

<h4 id="redux">Redux</h4>

<p><img height="75" width="75" src="/img/lyricallarch/redux.svg"/></p>

<p>All of these actions are initiated by various Service functions located under <code>src/services/</code>, such as <code>GetUsersSmartPlaylists()</code> from the <code>SmartPlaylistService.ts</code> file.</p>

<p>Each service method sends a notification to the Redux Action Creators under <code>src/actions/actionCreators/</code>, which, using the <code>Redux-Thunk</code> package, then asynchronously initiates a number of related Redux Actions:</p>

<ul>
<li>a Requested action</li>
<li>a Failed action</li>
<li>a Succeeded action</li>
</ul>

<p>When Redux is altered of a Requested action, depending on the operation, such as if it is a network transaction, the relevant sections of the Store have their <code>IsLoading</code> flag flipped, or set <code>IsModalOpen</code>, enabling the Loading Screen for the application.</p>

<p>If a request fails for any reason, the appropriate Failed Action is initiated, the loading flags are disabled, and an error message is displayed to the user.</p>

<p>If a request succeeds, then the data is cached in the appropriate place and the pages controls are updated to reflect the change in state.</p>

<h4 id="react">React</h4>

<p><img height="75" width="75" src="/img/lyricallarch/react.svg"/></p>

<p>There are a number of components the project uses, most are located under <code>src/components/</code>, but some which require direct Redux access are located under <code>src/containers/</code>. Some of these controls include</p>

<ul>
<li>PagingBox, which controls flipping through pages of Spotify Playlists, Smart Playlists, or Listeners</li>
<li>ListenerTree, which is a wrapper for <code>react-sortable-tree</code>, and</li>
<li>RuleNode / RuleGroupNode, which are how Lyricall displays its atomic units</li>
</ul>

<p>These components were made as Stateless Function Components (SFC) by default, and upgraded to a full Class if necessary, such as is the case with with <code>ListenerTree</code>.</p>

<p>All these components have their corresponding ReactProps and ReactState if necessary, and are of course typed.</p>

<p>These react components are how the user interacts with Lyricall - and either directly or indirectly are what call the back end REST API.</p>

<h2 id="back-end">Back End</h2>

<h3 id="database-postgresql">Database - PostgresQL</h3>

<p><img height="75" width="75" src="/img/lyricallarch/postgres.svg"></p>

<h4 id="why-postgres">Why Postgres</h4>

<p>During the initial setup, I was conflicted on what to use for the Database. I have a lot of experience with SQLite, but as the developer says, SQLite is a replacement FOpen(), not a database. Lyricall is a small project that will likely see very few people using it, let alone concurrently. In this instance, SQLite would probably have been a fine choice for the back end database, but I took it as a learning project to get familiar with a real production database.</p>

<p>The standard options for anyone wanting to deploy such a database includes the usual suspects:</p>

<ul>
<li>MySQL</li>
<li>PostgresQL</li>
<li>SQL Server</li>
<li>MongoDB</li>
</ul>

<p>In addition, there are a bunch of other non standard databases that are interesting as well:</p>

<ul>
<li>RethinkDB</li>
<li>Cassandra</li>
<li>MariaDB</li>
</ul>

<p>While surely useful in their niches and certainly interesting in their own right, it seemed like a good idea to steer clear of that second set of databases, leaving us in the first set. My impression upon hearing the word &ldquo;MySQL&rdquo; is to recoil - after all, it is an Oracle project, and separately has a reputation for being a stodgey old-timer. Although research revealed that modern day MySQL seems to have caught up to the pack, I just didn&rsquo;t feel like using it.</p>

<p>SQL Server is, I hear, a fantastic database, but it is a Microsoft enterprise offering meaning that it comes with an incredible price tag. I am not averse to paying money for a good solution, but the database space is special in that there&rsquo;s really no reason to. The open source solutions are cutting edge, stable, and well documented. Why pay for what I don&rsquo;t have to?</p>

<p>Thus the choice came down to either Mongo or Postgres. Although Mongo specifically, and NoSQL options more generally are darlings of practitioners of modern web design, my work with previous databases combined with the fact that my software engineering upbringing was not on the web, leaves me with a visceral dislike of NoSQL.</p>

<p>The idea that my data is unstructured, as a general statement, strikes me as profoundly wrong. Aside from certain fields like genomics where the data really can&rsquo;t be counted on to be structured, or in situations where massive horizontal sharding is required, a NoSQL solution seems like the wrong choice. Additionally, though perhaps more personally, the idea that a structured database with strong types slows down development time is ludicrous. For myself at least, strong types are necessary for moving fast.</p>

<p>By process of elimination therefore, PostgresQL was the last man standing. I&rsquo;d like to note that the tooling is really what won it for Postgres. Although not quite as extensive as Mongo&rsquo;s tooling, there is just the right amount of excellent support for the database - a good enough GUI client; iron-clad official documentation; thousands of competently answered StackOverflow questions; And most importantly, a fabulous .NET Core library that both integrates with Entity Framework and allows for complete manual control.</p>

<p>If a a few of those, but most significantly the .NET Core library, were missing, I would have been forced to go with Mongo - thankfully I was able to avoid the swamp of misery that I&rsquo;ve been mired in before with that database, and was able to successfully and pleasantly work with Postgres. I couldn&rsquo;t be happier with this decision.</p>

<h4 id="database-schema">Database Schema</h4>

<p>There are 2 disjoint sets of tables in the schema - one is the custom Lyricall-only set of tables, and the other is the set of tables that comes with ASP.NET / Entity Framework&rsquo;s authentication and identity addon.</p>

<h5 id="lyricall-tables">Lyricall Tables</h5>

<p><img src="/img/lyricallarch/LyricallTable.PNG"/></p>

<p>SmartPlaylists was intended on being the top-level table, but it ended up being that RuleGroups was the top-level. Meaning that in order to completely clear all lower level entries, deleting the rule group takes care of that, while deleting the Smart Playlist will leave remnant entries around.</p>

<p>That being said, it functions perfectly fine, and is in no way an urgent or even necessary fix. It&rsquo;s really just a design quirk.</p>

<p>The scheme here is the product of a lot of back and forth about how best to represent the persistence layer. There&rsquo;s an impedance mismatch between objects stored in memory and objects stored in a tabular format - this is of course well documented, well understood, and if one has the proper training, well taught. But it doesn&rsquo;t go away, and figuring out how to resolve the mismatch in not just one direction, but two, is always an effort that will be resolved to better or worse degrees.</p>

<p>Some things map one-to-one, like Sources. In memory, I have a Playlist object, which contains a bunch of metadata like</p>

<pre><code class="language-csharp">class SpotifyPlaylist : SpotifySource {
  string PlaylistName;
  User Owner;
  string SpotifyId;
  string SnapshotId;
}
</code></pre>

<p>among other fields. The main playlist object has more complicated fields like its own tracks, but Lyricall has no need to keep track of that, and can safely ignore their existence. This leaves us a simple object that can be mapped easily to a table with the fields</p>

<pre><code class="language-sql">CREATE TABLE Sources(
  ID TEXT Primary Key,
  OwnerID TEXT, 
  PlaylistName TEXT,
  SnapshotId TEXT,
);
</code></pre>

<p>Easy.</p>

<p>We go slightly astray from a simple mapping when we have to account for the User Library, a Spotify object that resembles a playlist but is critically different. It has no Id, no Owner, and no Name. But it functions like a playlist, is structured like a playlist, and is handled, by the end user, like a playlist. And yet, it is not a playlist. So in memory, we end up with an object that looks like this,</p>

<pre><code class="language-csharp">class UserLibrary : SpotifySource {

}
</code></pre>

<p>Yes, it is empty.</p>

<p>Its purpose is to be a differentiator in a list of Sources, held in memory. There are operations we perform that go over a list of Sources, and the two available types of sources are <code>SmartPlaylist</code> and <code>UserLibrary</code>.</p>

<p>Unfortunately now we have to put that into the same <code>Sources</code> table as well. There are surely other ways to solve this particular issue, but I settled on what&rsquo;s known as a discriminator, a field that exists in the Database but does not exist on the in-memory class, letting us serialize and deserialize with much more certainty.</p>

<pre><code class="language-sql">CREATE TABLE Sources(
  ID TEXT Primary Key,
  OwnerID TEXT, 
  PlaylistName TEXT,
  SnapshotId TEXT,
  IsLibrary BOOLEAN
);
</code></pre>

<p>That wasn&rsquo;t too hard either.</p>

<p>Where we&rsquo;ve run into the trickiest problem of the Database was transforming our tree-like rule structure into flat, tabular one.</p>

<p>In memory our rules look like this</p>

<pre><code class="language-csharp">interface Listener {
  [...]
}

class Rule : Listener {
  [...]
}

class RuleGroup  : Listener {
  [...]
  List&lt;Listener&gt; rules;
  [...]
}
</code></pre>

<p>A <code>Rule</code> is a <code>Listener</code>.
<br/>Not a problem. Add a Rule table.</p>

<p>A <code>RuleGroup</code> is a <code>Listener</code>.
<br/>Still not a big deal, add mapping table with a discriminator.</p>

<p>A <code>RuleGroup</code> can contain arbitrarily deep nested <code>Listeners</code>, which in turn may also contain arbitrarily deep nested <code>Listeners</code>.
</br>Now we&rsquo;re getting into a fun problem.</p>

<p>The solution is to use a mapping table with a loop. Each entry in the RuleMap points to either:</p>

<ul>
<li>A <code>Rule</code> entry, or</li>
<li>A <code>RuleGroup</code> entry</li>
</ul>

<p>with the <code>IsRuleGroup</code> we&rsquo;re able to at least determine what kind of <code>Listener</code> we&rsquo;re looking at, but if we&rsquo;ve referenced a <code>RuleGroup</code>, then we still have the problem of getting the next layer of <code>Listeners</code> that <code>RuleGroup</code> has. Thus we have a <code>ParentRuleGroupId</code> field which is a key to both a <code>RuleGroup</code> and a recursive entry in <code>RuleMap</code>, solving our arbitrary nesting problem.</p>

<p>To an experienced developer, this solution likely sounds either obvious or suboptimal. For a developer like myself who has much experience with SQL but only a handful of run-ins with tree data, this was, while not a huge challenge, certainly not obvious.</p>

<p>There are a handful of other tables connected here. Their purposes are, briefly:</p>

<ul>
<li><code>ScansInProgress</code>: If a playlist is being scanned and hasn&rsquo;t completed, it goes here. Prevents launching multiple scans of the same Smart Playlist.</li>
<li><code>StagedTracksAddedMap</code>: Tracks that meet the criteria for a Smart Playlist are placed here until they can be uploaded successfully. Prevents permanent non-addition of tracks due to server failure.</li>
<li><code>TracksAddedMap</code>: Tracks that have been successfully added are removed from <code>StagedTracksAddedMap</code> and placed here. Prevents adding duplicate tracks to the same playlist. May be cleared by a <code>force</code> scan.</li>
<li><code>LyricallConditions</code> and <code>LyricallProperties</code>: Database versions of Lyricall Rule Properties. Prevents tampering of incoming data, such as if someone were to supply a field for rule scans that didn&rsquo;t exist. This is essentially a source of truth. No operations by the server ever modify this.</li>
</ul>

<h5 id="straggler-tables">Straggler Tables</h5>

<p><img src="/img/lyricallarch/Misc.PNG"/></p>

<ul>
<li><code>_EFMIgrationsHistory</code>: Entity Framework curated migration table. Not relevant to this technical discussion.</li>
<li><code>ScanLimits</code>: Records how many times a User has requested a scan in a single Lyricall-Day. Because I try to avoid maxing out my Spotify API rate limit, this table restricts users from spamming scans. The limit is set by the Server, but hovers around 10 scans a day.</li>
<li><code>SpotifyAudioAnalysis</code>: A JSON store table keeping the extremely heavy <code>AudioAnalysis</code> objects from Spotify. This, along with <code>SpotifyAudioFeatures</code>, are caching tables which allow us to minimize calls to the Spotify API service.</li>
<li><code>SpotifyAudioFeatures</code>: Caches from the <code>get-audio-features</code> Spotify endpoint.</li>
</ul>

<h5 id="asp-net-entity-framework-tables">ASP.NET / Entity Framework Tables</h5>

<p><img src="/img/lyricallarch/EfCoreTable.PNG"/>
These are included for completeness&rsquo; sake, but are completely auto-generated by the Entity Framework&rsquo;s migration tools <code>dotnet ef migrations add</code> and <code>dotnet ef migrations update</code>.</p>

<p>Noteworthy is mostly that an <code>AspNetUser</code> is a 1:1 mapping of a <code>SpotifyUser</code>, minus a bunch of fields that aren&rsquo;t supplied by Spotify or aren&rsquo;t useful to the lyricall.net service .</p>

<p>We also store the users OAuth access and refresh tokens in the <code>AspNetUserTokens</code> table.</p>

<p>In the future, I&rsquo;d like to Linux the deletion of a user to the automatic deletion of their SmartPlaylists/RuleGroups via a foreign key constraint on <code>SmartPlaylists.OwnerId</code> =&gt; <code>AspNetUser.Id</code>, but as it stands now, doing a manual query on matching OwnerIds is a perfectly fine process.</p>

<h3 id="server-net-core-2-0-asp-net-core-2-0">Server - .NET Core 2.0 / ASP.NET Core 2.0</h3>

<p><img height="75" width="75" src="/img/lyricallarch/netcore.svg"/></p>

<h4 id="why-net-core">Why .NET Core</h4>

<p>Similar to the discussion preceding the choice of Postgres as my database, I also had to make the decision of what would be the primary server.</p>

<p>The choices were:</p>

<ul>
<li>Node (JavaScript)</li>
<li>Flask or Django (Python)</li>
<li>Rails (Ruby)</li>
<li>ASP.NET Core</li>
</ul>

<p>Reading anything about web development over the last 5 years would lead one to believe that there is only NodeJS, and that all others are pretenders. Thankfully that isn&rsquo;t so, and despite the mind bogglingly immense amount of articles, StackOverflow posts and hackathons evangelizing it, there are numerous better alternatives.
<br>And that&rsquo;s fabulous, because like Mongo, my experience with Node isn&rsquo;t amazing, and I&rsquo;d like to avoid it if I can get away with it.</p>

<p>Coming from a heavy C# background also means coming with a number of convictions and expectations that are often in diametric opposition to the values espoused in modern, or at least, vocal, web development circles. For example, like most people, I don&rsquo;t like JavaScript. But heretically, I also don&rsquo;t think it&rsquo;s necessary. I understand that it is the lingua franca of the front-end web, but why for the love of god must I put it on my server too? There is simply no need for that. As long as I have a say in it, there&rsquo;s no room for JavaScript on the server while better solutions exist. I&rsquo;d damn sooner write something in pure C than JavaScript.</p>

<p>Strike Node from the list.</p>

<p>Flask or Django are certainly nice servers, and Python is a wonderful language, especially since the community has decided to finally move to 3+, but I just wasn&rsquo;t that keen on doing what I imagined would be a decently complicated application in a dynamically typed language. That&rsquo;s even with me knowing Python very well. The problem is compounded for a language like Ruby, which I don&rsquo;t know anything about at all.</p>

<p>Barring the more interesting choice of .NET Core, I&rsquo;d likely have chosen one of the Python servers, but .NET Core 2.0 had recently entered the final stages of its pre-release cycle, and the beta was rapidly approaching an end. In addition, I am extremely well versed in C# and enjoy the language immensely.</p>

<p>This decision was just as easy as the database one.</p>

<p>.NET Core 2.0 it would be.</p>

<h4 id="intermission-the-dotnetstandardspotifywebapi-library">Intermission - the DotNetStandardSpotifyWebApi library</h4>

<p><img height="75" width="75" src="/img/lyricallarch/spotify.svg"/></p>

<p>Before we discuss how the actual backend operates, its important to draw attention to two external dependencies of the lyricall project - the <a href="https://github.com/0xNF/DotNetStandardSpotifyWebApi">DotNetStandardSpotifyWebApi</a> and <a href="https://github.com/aspnet/Security">ASP.NET Security</a> project.</p>

<p>I&rsquo;ve been using Spotify as a testing grounds for a number of projects, some of which get released, others which don&rsquo;t - but whenever there&rsquo;s an idea I&rsquo;d like to test out or try, Spotify is often the first place I turn to provide some kind of application for the concept.</p>

<p>Originally I had a project that helped a user classify songs according to some user-specified criteria, which required pulling from the Spotify web api, pushing back to the service, and performing other related operations. This application was built as an early UWP project, and had a tightly coupled, highly intermixed way of interacting with the Spotify API.</p>

<p>Eventually the Spotify API portion was spun off into off into its own library, although it was still coupled around UWP, and was thus not portable outside the platform.</p>

<p>With the release of .NET Core also including the reveal of the <a href="https://github.com/dotnet/standard/blob/master/docs/versions.md">.NET Standard</a>, which specifies a unified API surface across all .NET implementations, it felt like the right time to update my Spotify Library. Although a lot of the building blocks were in place from all these prior iterations, specifically the data structures around the formalizing of json structures into C# classes like the <code>Track</code> or <code>Album</code>, much of the plumbing around fetching the data wasn&rsquo;t up to par.</p>

<p>After a number of days of work refreshing the project for use as a .NET Standard library and writing tests for it, it looked good enough to place on GitHub, where it resides now. It isn&rsquo;t finished, although it close. I imagine the remaining gaps will be filled in when I do a project that requires the missing features.</p>

<p>The Library provides an abstraction around Spotify&rsquo;s API, allowing for someone to simply request a <code>Track</code> by the specified <code>Artist</code>, or to work easily on a <code>Playlist</code>, or any other such way of using their API.</p>

<h4 id="intermission-the-asp-net-security-project">Intermission - the ASP.NET Security Project</h4>

<p>Just having an easy-and-ready-to-use Spotify library wasn&rsquo;t enough to begin work on the Lyricall.</p>

<p>Because the application is entirely dependent upon a user and their Spotify account, it&rsquo;s necessary to be able to authenticate with Spotify and get a token that can be used to act upon the users account. Spotify, like many APIs, supports this scenario via the <code>OAuth 2.0</code> authentication process.</p>

<p>I had, in the earlier versions of the <code>DotNetSpotifyWebApi</code> library, done this kind of OAuth authenticating by hand, which was overly reliant upon specific HTTP Clients in the .Net Framework, were prone to various failures, and was as a whole an unstable ill-tested mess liable to collapse at any moment.</p>

<p>As I was in the midst of updating that library anyway, it seemed like a good time to shop around for more professional authentication solutions than my own hand-rolled one, an enlightening learning experience though it was.</p>

<p>Research led me around the internet to various places and projects but none really fit the bill for what I needed. There were handfuls of pre-existing libraries for this that were built for NodeJS or Flask, but none for ASP.NET.</p>

<p>Given that Microsoft had recently open-sourced the entire .NET platform, and because Microsoft supplies a small number of official implementations for authenticating against various services, I decided to write another OAuth authenticator based around how Microsoft did it.</p>

<p>This was a successful endeavor, but it was hodgepodged together with kludges and certainly not best-practice development choices. As I later put it on a GitHub issue, it was a &ldquo;homeless amalgam&rdquo;. Bits from here, bits from there, and no real good place to put it for future use.</p>

<p>After some additional research some number of days later, I came across a promising community project, Linuxed to from the official Microsoft docs, about OAuth processing for ASP.NET, called the <a href="https://github.com/aspnet/Security">ASP.NET Security</a> project, which contained dozens and dozens of pre-supplied and pre-tested OAuth plugins for providers like YouTube, Twitch, Baidu, and others. Unfortunately, their main branch, while massive and thorough, was only for <code>.NET Core 1.0</code>. The 1.0 release and the 2.0 release had enough breaking changes that it was impossible to use 1.0 libraries as a drop-in solution in 2.0 projects, and unfortunately, 2.0 is where I had invested my time.</p>

<p>This led me to prowl around their issue tracker, where I found a thread asking about <code>.NET Core 2.0</code> versions of the project - although there had been a fair amount of activity in that thread, it looked pretty dead by the time I arrived. Nevertheless, I posted about my working-but-wonky Spotify authentication, and asked if there was work being done that I could contribute to.</p>

<p>Fortunately for me, this necroposting revived the thread and spurred a bunch of latent activity on the project - including from the maintainers, who pointed me towards a beta 2.0 branch, and suggested placing my project there.</p>

<p>I had to scrap and rewrite my authentication program because it was so far out of the project guidelines, but in the end I was able to produce a well formatted and complete Spotify authentication solution for this project. Maybe others will find it useful as well.</p>

<p>The wonders of Open Source.</p>

<h4 id="api">API</h4>

<p>There are presently 18 public endpoints structured as a REST application that a client may hit:</p>

<table>
<thead>
<tr>
<th>method</th>
<th>endpoint</th>
</tr>
</thead>

<tbody>
<tr>
<td>GET</td>
<td>/api/v1/revoke</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/playlists?id={id}</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/playlists</td>
</tr>

<tr>
<td>POST</td>
<td>/api/v1/playlists</td>
</tr>

<tr>
<td>DELETE</td>
<td>/api/v1/playlists?id={id}</td>
</tr>

<tr>
<td>DELETE</td>
<td>/api/v1/unfollow?id={id}</td>
</tr>

<tr>
<td>DELETE</td>
<td>/api/v1/deletesmart?id={id}</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/fetch?id={id}</td>
</tr>

<tr>
<td>POST</td>
<td>/api/v1/playlists/update</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/me/smartplaylists</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/me/Spotifyplaylists</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/premade/</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/fetch?id={id}&amp;force=[t/f]</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/pause?id={id}</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/resume?id={id}</td>
</tr>

<tr>
<td>PUT</td>
<td>/api/v1/clear?id={id}</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/tracks?id={id}</td>
</tr>

<tr>
<td>GET</td>
<td>/api/v1/listenerinfo</td>
</tr>
</tbody>
</table>

<h4 id="server-architecture">Server Architecture</h4>

<p>At the root level, the project is structured to contain multiple projects, including tests, and includes that aren&rsquo;t available on Nuget yet. That looks like this:</p>

<pre><code>Lyricall/
    AspNet.Security.OAuth.Spotify/
    DotNetStandardSpotifyWebApi/
    Lyricall.IntegrationTests/
    Lyricall.UnitTests/
    Lyricall/
</code></pre>

<p>Of course the magic happens in <code>Lyricall/Lyricall/</code>:</p>

<pre><code>Lyricall/
    wwwroot/
    Client/
    Controllers/
    Data/
        Migrations/
    Models/
        Domain/
        Staged/
    Services/
    Views/
</code></pre>

<p><code>wwwroot/</code> stores our deployed front end, which is the fully compiled forms of the TypeScript project, as well as the static html files found under <code>Client/</code>.</p>

<p>Like all ASP.NET projects, the public API is defined by the controllers located under <code>Controllers/</code>. Logins are processed via <code>Home.cs</code> and <code>Account.cs</code>. These are holdovers from the default project where corresponding <code>Views/Home.cshtml</code> and <code>Views/Account.cshtml</code> views existed. Although the naming and structure is somewhat vestigial, their login and authentication functionality remains.</p>

<p>The heavy lifting API is defined by the <code>Controller/SmartPlaylists.cs</code> file. This is where <code>GetAPlaylist()</code>, <code>Update()</code>, <code>ClearAddedTracks()</code>, and the rest of the public API reside.</p>

<p>Sign in and authentication happen by first hooking the Spotify OAuth project into the <code>Startup.ConfigureServices()</code> method:</p>

<pre><code class="language-csharp">services.AddAuthentication().AddSpotify((options =&gt; {
        AppConstants.ClientId = Configuration[AppConstants.ClientIdKey];
        AppConstants.ClientSecret = Configuration[AppConstants.ClientSecretKey];
        options.ClientId = AppConstants.ClientId;
        options.ClientSecret = AppConstants.ClientSecret;
        options.SaveTokens = true;
        options.Scope.Add(DotNetStandardSpotifyWebApi.Authorization.SpotifyScopeEnum.PLAYLIST_MODIFY_PUBLIC.Name);
        options.Scope.Add(DotNetStandardSpotifyWebApi.Authorization.SpotifyScopeEnum.PLAYLIST_READ_COLLABORATIVE.Name);
        options.Scope.Add(DotNetStandardSpotifyWebApi.Authorization.SpotifyScopeEnum.PLAYLIST_READ_PRIVATE.Name);
        options.Scope.Add(DotNetStandardSpotifyWebApi.Authorization.SpotifyScopeEnum.USER_LIBRARY_READ.Name);
}));
</code></pre>

<p>The scope additions are what this particular Spotify-API based application needs, which is the ability to:</p>

<ul>
<li>Read and write access to a user&rsquo;s public playlists so that we may add songs</li>
<li>Read and write access to a user&rsquo;s collaborative playlists for the same reason</li>
<li>Read and write access to a user&rsquo;s private playlists, for the same reasons</li>
<li>Read access to a user&rsquo;s Library, so we can use it as a source</li>
</ul>

<p>There are a handful of other permissions that we could request, but Lyricall doesn&rsquo;t need them to work, so we do not have to request any extraneous permissions.</p>

<p>We also use the built-in ASP.NET identity module, which uses the Entity Framework to handle the database structure, serializing/deserializing, and migration creation with respect to Users:</p>

<pre><code class="language-csharp">    services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;()
        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()
        .AddDefaultTokenProviders();
</code></pre>

<p>The ApplicationDbContext contains the necessary information for the application to create the identity table structures. This comes as a freebie default by creating an ASP.NET identity application.</p>

<h5 id="entity-framework-vs-hand-crafted-sql">Entity Framework vs Hand Crafted SQL</h5>

<p>There&rsquo;s a point of discrepancy which should be addressed at this point. We use Entity Framework to handle identity, but we constructed all the other relevant tables in the Lyricall database by hand. In fact, we never use Entity Framework, or any further ApplicationDbContexts at all beyond its one purpose. The reason for this is the embodiment of a long-running argument in the programming community about ORMs vs No ORMs. ORMs make it easy to do simple things like accessing one table with no dependencies on other tables, but performing joins or ensuring foreign key constraints quickly undoes the benefits of the ORM.</p>

<p>Additionally, ORM&rsquo;s have a tendency to require that the code be mutilated to appease it - suddenly there are decorates everywhere, public methods, getter/setters on every field. Principles of least access and separation of concern are sacrificed to fit the code model that the ORM expects in order to function properly.</p>

<p>An ORM is not without its benefits - they make migrations dead simple, easily auditable, trivially reproducible - but for me, the benefits do not counter the sheer weight they add to the project.</p>

<p>Thus, lyricall is a mixed project, where the things that are handled well and by default by the ORM like Identity and Authorization, are allowed to do so, while the custom sections of the application are done by hand.</p>

<h5 id="automatic-timed-services">Automatic Timed Services</h5>

<p>Returning to <code>Startup.cs</code>, we have a number of hosted services:</p>

<pre><code class="language-csharp">//These two singletons are responsible for populating the list of To-Scan items every 10 minutes
services.AddSingleton&lt;UpcommingScansProvider&gt;();
services.AddSingleton&lt;IHostedService, ScansRefreshService&gt;();
//These two singletons are responsible for actually dequeuing and scanning the items from the previous service
services.AddSingleton&lt;ScannerProvider&gt;();
services.AddSingleton&lt;IHostedService, ScanProviderService&gt;();
//These two singletons are responsible for resetting everyone's Scan Counts at midnight
services.AddSingleton&lt;ScanCountResetProvider&gt;();
services.AddSingleton&lt;IHostedService, ScanCountResetService&gt;();
</code></pre>

<p>The comments should be explanatory. These services run at specified intervals and are responsible for ensuring the continuing automatic operation of the server. This way, a user&rsquo;s smart playlist can be updated without further input by the user.</p>

<h5 id="services">Services</h5>

<p>The public API of the controllers is generally self contained, and strives to keep a separation between it and other parts of the application. When interoperability between application sections is required, travel through some of the static <code>Service</code> classes is encouraged.</p>

<p>For example, interaction with Spotify, via the <code>DotNetStandardSpotifyWebApi</code> library, is further abstracted out into the <code>SpotiifyService</code> class, where methods like <code>CreateSpotifyPlaylist()</code>, <code>FetchAudioFeatures()</code>, and <code>UploadSongs()</code> reside.</p>

<p>Interaction with the Database goes through the <code>DatabaseService</code> class. In specific, the DatabaseService class is split into two <code>partial class</code> sections - one which defines the actual database methods like <code>GetSmartPlaylistSources</code> and <code>SetSourceScanCrashPoint</code>, and another which contains private classes and structures needed, such as <code>PlaylistMetadata</code>, <code>FlattenedStagedListeners</code> as well as methods which specifically operate upon or with those classes.</p>

<p>Previously mentioned auto-timer services also reside under <code>Services/</code>.</p>

<h5 id="models">Models</h5>

<pre><code class="language-filesystem">Models/
    Domain/
        Listener/
            ErrorObject.cs
            Listener.cs
            RuleGroup.cs
            Rule.cs
        LyricallException.cs
        LyricallCondition/
            LyricallCondition.cs
            StringCondition.cs
            NumberConditon.cs
            BooleanCondition.cs
        LyricallObject/
            LyricallObject.cs
            AdditionalDataFlags.cs
            LyricallMatchObject.cs
            SmartPlaylist.cs
            SimpleSmartPlaylist.cs
            LyricallTrack.cs
            LyricallPaging.cs
            PremadeListeners.cs
        LyricallProperty/
            LyricallProperty.cs
            TrackProperty.cs
            AlbumProperty.cs
            ArtistProperty.cs
            AudioFeaturesProperty.cs
            PlaylistProperty.cs
            LibraryProperty.cs
            Range.cs
            LongRange.cs
            IntNumberRange.cs
            DoubleNumberRange.cs
            StringRange.cs
            BooleanRange.cs
        ProgressObject/
            NextScanTimes.cs
            ProgressObject.cs
        SpotifySource/
            SpotifySource.cs
            SpotifyPlaylist.cs
            UserLibrary.cs
        UserTokens.cs
    Staged/
        StagedListener/
            StagedListener.cs
            StagedRuleGroup.cs
            StagedRule.cs
        StagedSmartPlaylist.cs
        ValidationReasult.cs
        
</code></pre>

<p>Lyricall is focused around automatically updating Smart Playlists - and almost every class represented within are directly in support of that.</p>

<p>The core class is <code>SmartPlaylist</code>, which is structured, with simplifications, like this:</p>

<pre><code class="language-csharp"> public class SmartPlaylist {
        public const string Type = &quot;SmartPlaylist&quot;;
        /// Spotify ID generated on submitting a Create Playlist request to Spotify
        public string PlaylistId { get; }
        /// Spotify ID of the user who owns this playlist. 
        /// In context of Smart Playlists, it is always the user who created it
        public string OwnerId { get; }
        /// Name of the Playlist - the User specifies its name.
        public string PlaylistName { get; }
        /// The timestamp of the last source scan this playlist underwent
        public DateTime LastFetched { get; }
        /// Timestamp of the next upcoming source scan this playlist will undergo
        public DateTime NextFetch { get; }
        /// The list of sources this Smart Playlist draws from
        public IReadOnlyList&lt;SpotifySource&gt; Sources { get; }
        /// The top level group to match on.
        /// May contain a single Rule, or RuleGroup, or any number of any combination
        public RuleGroup Listeners { get; }
        public JObject ToJson();
        internal static bool HasAtLeastOneRule(SmartPlaylist sp);
    }
</code></pre>

<blockquote>
<p>All classes that get sent JSONified and sent to a client have two properties: a <code>const string Type</code> field which nominalizes the class for use in a JavaScript deserializer, and a <code>public JObject ToJson()</code> method, which does what it says on the tin, using the now-built-in <code>Newtonsoft.Json</code> library.</p>
</blockquote>

<p>The Smart Playlist is the complex, fully constructed main functional unit of the application. It&rsquo;s two most important aspects are the <code>Sources</code> field and the <code>Listeners</code> field.</p>

<p><code>Sources</code> is the list of Spotify Sources that this playlist is designated to draw from - this can be a user&rsquo;s <code>Saved Songs</code>, or any <code>Playlist</code> that they follow on Spotify. Sources are very simple classes, which implement the <code>SpotifySource</code> interface.</p>

<p><code>Listeners</code> is the source of nearly all of Lyricall&rsquo;s complexity - much effort has been put into attempting to compensate and work around the complexity of this field. Two aspects of the complexity are because listeners are arbitrarily nested trees of listeners which has implications for scanning/matching and database de/serialization, and also because there is a fairly broad amount of things that can be listened for, which are each narrowly defined in terms of their accepted values.</p>

<p>An easy but wrong way to counter the complexity would be to simply leave user-input unguided and unvalidated - but we&rsquo;ve chosen to formalize what a listener is allowed to do, what accepted values are and what range they fall into. For example, a Track Property defines the fields that can be listened to when evaluating a specific track:</p>

<pre><code class="language-csharp">public class TrackProperty : LyricallProperty {
        public static readonly TrackProperty TrackName = new TrackProperty(0, &quot;Track Name&quot;, StringCondition.AllConditions, StringRange.GenericRange);
        public static readonly TrackProperty Markets = new TrackProperty(1, &quot;Available Markets&quot;, StringCondition.AllConditions, StringRange.GenericRange);
        public static readonly TrackProperty DiscNumber = new TrackProperty(2, &quot;Disc Number&quot;, NumberCondition.AllConditions, IntNumberRange.GenericRange);
        public static readonly TrackProperty Duration = new TrackProperty(3, &quot;Duration&quot;, NumberCondition.AllConditions, IntNumberRange.DurationRange);
        public static readonly TrackProperty Explicit = new TrackProperty(4, &quot;Explicit&quot;, BooleanCondition.AllConditions, BooleanRange.GenereicRange);
        public static readonly TrackProperty Popularity = new TrackProperty(5, &quot;Popularity&quot;, NumberCondition.AllConditions, IntNumberRange.DurationRange);
        public static readonly TrackProperty TrackNumber = new TrackProperty(6, &quot;Track Number&quot;, NumberCondition.AllConditions, IntNumberRange.GenericRange);
    }
</code></pre>

<blockquote>
<p>The constructor and supporting fields are omitted for clarity&rsquo;s sake, but they include a <code>private static Dictionary&lt;int, TrackProperty&gt;</code> for in-memory storage.</p>
</blockquote>

<p>A <code>TrackProperty</code> can be a listener assigned to a few specific fields:</p>

<ul>
<li>Track Name</li>
<li>Available Markets</li>
<li>Disc Number</li>
<li>Duration</li>
<li>Explicit</li>
<li>Popularity</li>
<li>Track Number</li>
</ul>

<p>Each of those fields has specific value types and value ranges they accept, and are specified by their third constructor argument. For example, <code>StringCondition.AllConditions</code> means the field accepts <code>string</code> values, and its allowed conditions includes</p>

<ul>
<li>is</li>
<li>is not</li>
<li>contains</li>
<li>does not contain</li>
<li>starts with</li>
<li>does not start with</li>
<li>ends with</li>
<li>does not end with</li>
</ul>

<p>Meanwhile, <code>Duration</code> is <code>NumberCondition.AllConditions</code>, meaning it accepts integers (as specified by the Spotify API, duration is an integer not a long), and its allowed conditions include:</p>

<ul>
<li>Less Than</li>
<li>Less Than Or Equal To</li>
<li>Greater Than</li>
<li>Greater Than Or Equal To</li>
<li>Equal To</li>
<li>Not Equal To</li>
</ul>

<h5 id="validation">Validation</h5>

<pre><code class="language-csharp">public abstract class Listener: LyricallObject {
    public int Id { get; }
    public abstract AdditionalDataFlags AdditionalDataFlags { get; }
    public abstract bool Matches(LyricallMatchObject lmo);
}

public class RuleGroup : Listener {
    public string GroupName { get; }
    public EveryAny EveryAny { get; }
    public IReadOnlyList&lt;Listener&gt; Rules { get; }
    private AdditionalDataFlags _AdditionalDataFlags = AdditionalDataFlags.Unset;
}

 public class Rule : Listener {
    public LyricallProperty Property { get; }
    public LyricallCondition Condition { get; }
    private AdditionalDataFlags _AdditionalDataFlags = AdditionalDataFlags.Unset;
    public string Value { get; }
    private Func&lt;LyricallMatchObject, bool&gt; Matcher { get; }
 }
</code></pre>

<p>When a rule, which is a combination of a specific <code>LyricallProperty</code> like <code>Duration</code> or <code>Artist Name</code> or <code>Danceability</code>, a a specific <code>LyricallCondition</code> like <code>Starts With</code> or <code>Greater Than</code>, and a value, it is run through a validation process which checks that:</p>

<ul>
<li>The Property is a valid, existing property and wasn&rsquo;t mal- or maliciously formed. i.e., <code>Coolness Level</code> is not a valid property.</li>
<li>The Condition is valid and wasn&rsquo;t also maliciously formed, and that it is correct for the Property. i.e., <code>Track Name Greater Than &quot;hello&quot;</code> is invalid.</li>
<li>The value falls within the specified range of the field. For example, negative values don&rsquo;t make any sense for some fields, meanwhile other fields are doubles between  <code>0.0 and 1.0</code>.</li>
</ul>

<p>A supplied rule that validates any of these assumptions fails validation and the client is supplied with an error message representing the issue.</p>

<p>This validation happens using specific <code>Staged</code> classes found under <code>Models/Staged/</code>. These classes are deserialized from json and usually ignore supplied Id fields, and are only allowed to touch certain parts of the inner applications. This prevents malicious or malformed input from affecting the system improperly.</p>

<h5 id="scanning">Scanning</h5>

<p>When a scan is requested, or when a scan is automatically triggered, an asynchronous scan is kicked off with the <code>NaiveScanner</code> class.</p>

<blockquote>
<p><code>NaiveScanner</code> is so named because future iterations are planned where playlists with similar sources will be batched together and matched at the same time, reducing our overall workload as well as stress on Spotify&rsquo;s servers. At the moment of writing however, this optimization does not occur, hence it is a naive scan.</p>
</blockquote>

<p>The scanner first loads a <code>SmartPlaylist</code> from the database by its <code>Id</code>, counts its sources, and then queue them up for scanning.</p>

<p>Each source checks a number of conditions, like if there any songs in it, or if it crashed or otherwise failed to complete an earlier scan - if it did fail, then it attempts to pick back up from the spot it failed at. Otherwise, it starts from the beginning, keeping track of its offset. A crash in the scan will update the Database with its last known offset, and will continue automatically at a later time, until a certain number of scan failures occur.</p>

<p>Failures can include any number of things such as Spotify enabling rate-limiting on the account, network failures, or token revocations. All of these initiate the crash-failure protocol.</p>

<p>The scanner has some optimizations in place to reduce load in various places:</p>

<ul>
<li>If the user no longer follows the smart playlist on their Spotify account, the SmartPlaylist is deleted form the Lyricall database and the scan as a whole does not proceed.</li>
<li>If a source has no songs, the scan for that source is marked as &lsquo;complete&rsquo; and completes early.</li>
<li>If a source hasn&rsquo;t changed since the last scan on this SmartPlaylist was performed (through the ETag attribute, or the SnapshotId attribute), then the scan for that source is marked as &lsquo;complete&rsquo; and completes early.</li>
<li>If a source reaches all the way to end, where there is no longer a defined <code>next</code> page to request, the scan is marked as complete.</li>
<li>If a source has changed since last time, we complete the scan for that source when we reach the last known position of the previous scan, preventing us from double-scanning sources and wasting api calls and bandwidth.</li>
</ul>

<p>If the Smart Playlist has a rule that needs access to <code>AudioFeatures</code> or <code>AudioAnalysis</code>  data, the Database cache is checked for presence of the data-heavy Audio object before asking Spotify for more data. Of course, the <code>GetMany</code> variant of the Spotify API call is used to minimize API rate limiting. If a call is necessary, we check against what is already in the cache, and only request the ones that we need. Although this does not affect our rate limit, it does lower the overall bandwidth required. New data returned is subsequently cached into the Database.</p>

<p>As a technical detail, we compile each track we see into a <code>LyricallMatchObject</code>, which rectifies the impedance mismatch between a <code>SavedTrack</code>, a <code>PlaylistTrackObject</code>, and a direct <code>Track</code>, which are all defined by Spotify, and are very similar but have slightly different semantics. This lets us scan over a user&rsquo;s <code>Saved Songs</code> library, a <code>Playlist</code> or, later, an <code>Album</code> or <code>Artist</code> without significant deviation in methods. This is especially useful when passing the track down the chain for the Rule Matching process.</p>

<p>Each track is passed to the Rule Matcher, which is a huge switch statement that simply checks if the value of the rule matches the value of the field in the track we&rsquo;re looking at.</p>

<p>Each matched rule returns a boolean, <code>true</code> for a successful match, <code>false</code> otherwise.
Within a <code>RuleGroup</code>, we check, depending on the flag, whether we need to match <code>all</code> rules or <code>any</code> rule. The obvious optimizations apply: If <code>all</code>, then a single <code>false</code> returns <code>false</code> for the group. If <code>any</code>, then a single <code>true</code> returns <code>true</code> for the group.</p>

<p>If a song passes all its checks, then it gets added to an in-memory list which, upon source scan completion, will be transferred to the databases <code>StagedTracks</code> table.</p>

<p>When the scan as a whole completes, the <code>StagedTracks</code> is scheduled to upload as soon as possible, and the <code>NextScan</code> and <code>LastScanned</code> fields are updated appropriately.</p>

<h2 id="hosting">Hosting</h2>

<h3 id="digital-ocean">Digital Ocean</h3>

<p><img height="75" width="75" src="/img/lyricallarch/digitalocean.svg"/></p>

<p>The Postgres instance resides on Digital Ocean. A number of other web services offer managed Postgres services, but they are often either expensive, confusing, or in beta. I looked at Heroku, but I was unsure on how to access the instance from outside the Heroku platform, and they constantly change the database credentials, meaning the lyricall.net server would require an additional Heroku library to properly interface with them to get the refreshed credentials. Since Heroku Postgres is designed to be used with other Heroku services and everything else seems secondary, I opted to not use them.</p>

<p>Azure was another choice, but a managed database requires a minimum service class of at least $39/month, which was out of scope for this project - in addition, managed Postgres is in beta on their platform.</p>

<p>So, back to Digital Ocean, my go-to default for whenever I need a cloud solution. Digital Ocean doesn&rsquo;t offer any managed services, but all I needed was a cheap linux host that I could install Postgres on, so I just opted for a $5/month Ubuntu 16 VM.</p>

<h4 id="security">Security</h4>

<p>Because it is a publically available computer, steps had to be taken to secure both the database and the computer.</p>

<p>An overview of the measures taken include:</p>

<ul>
<li>SSH only root login</li>
<li>Non-default SSH port</li>
<li>non-root account where any server actions are done</li>
<li>SSH only remote login to that account</li>
<li>Minimal other services running on machine</li>
<li>System firewall (ufw) for only the SSH port and the Postgres port</li>
<li>Randomized Postgres database name</li>
<li>Randomized Postgres username</li>
<li>Randomized Postgres password</li>
<li>EnforceSSL only connections to Postgres, with one authorized user on one database</li>
</ul>

<p>Further security considerations include only allowing Postgres connections from the static IP of the ASP.NET server, or somehow putting it on a Private Network with that server.</p>

<h4 id="backups">Backups</h4>

<p>None are performed. This is an obvious gap in the system and will be remedied in the future.</p>

<h4 id="ci-cd">CI/CD</h4>

<p>Unlike a managed solution, there is no quick way to deploy a new schema, and migrations must be done manually. This is another obvious gap.</p>

<h3 id="microsoft-azure">Microsoft Azure</h3>

<p><img height="75" width="75" src="/img/lyricallarch/azure.svg"/></p>

<p>Unlike the digital ocean offering, the Azure instance is a fully managed platform. Although they do offer open do-it-yourself VMs, for this project, I went with a managed Web-App. Technically it&rsquo;s using a windows server instance, but that&rsquo;s an implementation detail and can be changed at a later date with administrative minimal effort and zero programming effort.</p>

<p>Using an Azure Web App, we deploy our .Net Core 2.0 project via a git push. For most project dependencies, the .csproj file will specify what needs to be downloaded and the rest will handled by Azures deployment process. For the rest, such as <code>DotNetStandardSpotifyWebApi</code> and the unreleased <code>ASP.NET Security</code> branch, we bundle the projects directly with the release ourselves.</p>

<p>Combined with custom domain names purchased from NameCheap, we point our DNS to the Azure websites IP, and we have a functioning back end / front end / database client-server application.</p>

<h4 id="backups-1">Backups</h4>

<p>Given that the webapp on Azure is a managed service, backups happen automatically.</p>

<h4 id="ci-cd-1">CI/CD</h4>

<p>Configuring the Azure Web-App to use a local git repository means that any commit to an upstream <code>Azure</code> branch will automatically compile and deploy the application. With respect to CI, a separate project is set up within VSTS, but it isn&rsquo;t integrated into the deployment process yet.</p>

<h2 id="let-s-encrypt">Let&rsquo;s Encrypt</h2>

<p><img height="75" width="75" src="/img/lyricallarch/letsencrypt.svg"/></p>

<p>Security should never be an afterthought - the entire application from start to finish has been designed with security in mind, and the raw http connection is no different.</p>

<p>Let&rsquo;s Encrypt has made it quick and (mostly) easy to get an SSL certificate, so there&rsquo;s no reason not to anymore.</p>

<p>The Postgres server resides on an SSL-only connection from database to server with an LE certificate, although after obtaining the certificate it occurred to me that because the database is essentially a private network and I control both endpoints of the connection, that there&rsquo;s no need for a third-party certificate authority to sign the certificate. In the future, I will self-sign a certificate and use that as the encryption for the connection, removing an unnecessary dependency on a third party.</p>

<p>For the Azure web site however, Let&rsquo;s Encrypt is a godsend, if a huge hassle to set up. I followed Troy Hunt&rsquo;s excellent, if complicated <a href="https://www.troyhunt.com/everything-you-need-to-know-about-loading-a-free-lets-encrypt-certificate-into-an-Azure-website/">guide</a> on loading a third-party certificate to Azure.</p>

<p>Thanks to Let&rsquo;s Encrypt, there&rsquo;s never a single insecure connection established in any step of the lyricall.net chain</p>

</div>

    
<footer class='entry-footer'>
  
    
      
      <div class='categories'>
  <span class='category-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>

  </span>
  <span class='screen-reader'>Categories: </span><a class='category' href='/categories/lyricall.net'>Lyricall.net</a></div>

    
  
    
  
</footer>


  </article>

  
    

  

  
    <div class='comments-container'>
  
</div>

  
</main>

    <footer id='footer' class='footer-container'>
      <div class='footer'>
        <div class='social'>
  <nav aria-label='Social Menu'>
    <ul class='social-menu'><li>
        <a href='mailto:nflower@winetech.com' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Email account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>

        </a>
      </li><li>
        <a href='https://github.com/0xNF' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Github account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>

        </a>
      </li></ul>
  </nav>
</div>

        <div class='copyright'>
          <p>0xNF</p>

        </div>
      </div>
    </footer>

  </div>

  <script src='/js/main.af838dd5.js'></script>
  
    <script src='/js/prism.js'></script>
  
    <script src='/js/custom.js'></script>
  

</body>

</html>

